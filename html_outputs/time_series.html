<!DOCTYPE html>
<html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<title>23 Série temporelle et détection des épidémies | Le Epi R Handbook</title>
<meta name="author" content="the handbook team">
<meta name="description" content="23.1 Aperçu Cet onglet démontre l’utilisation de plusieurs paquets pour l’analyse des séries temporelles. Il s’appuie principalement sur les paquets de la famille tidyverts mais utilise également...">
<meta name="generator" content="bookdown 0.34 with bs4_book()">
<meta property="og:title" content="23 Série temporelle et détection des épidémies | Le Epi R Handbook">
<meta property="og:type" content="book">
<meta property="og:description" content="23.1 Aperçu Cet onglet démontre l’utilisation de plusieurs paquets pour l’analyse des séries temporelles. Il s’appuie principalement sur les paquets de la famille tidyverts mais utilise également...">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="23 Série temporelle et détection des épidémies | Le Epi R Handbook">
<meta name="twitter:description" content="23.1 Aperçu Cet onglet démontre l’utilisation de plusieurs paquets pour l’analyse des séries temporelles. Il s’appuie principalement sur les paquets de la famille tidyverts mais utilise également...">
<!-- JS --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://kit.fontawesome.com/6ecbd6c532.js" crossorigin="anonymous"></script><script src="libs/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="libs/bootstrap-4.6.0/bootstrap.min.css" rel="stylesheet">
<script src="libs/bootstrap-4.6.0/bootstrap.bundle.min.js"></script><script src="libs/bs3compat-0.4.2/transition.js"></script><script src="libs/bs3compat-0.4.2/tabs.js"></script><script src="libs/bs3compat-0.4.2/bs3compat.js"></script><link href="libs/bs4_book-1.0.0/bs4_book.css" rel="stylesheet">
<script src="libs/bs4_book-1.0.0/bs4_book.js"></script><script src="libs/htmlwidgets-1.6.2/htmlwidgets.js"></script><link href="libs/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet">
<script src="libs/datatables-binding-0.28/datatables.js"></script><link href="libs/dt-core-1.13.4/css/jquery.dataTables.min.css" rel="stylesheet">
<link href="libs/dt-core-1.13.4/css/jquery.dataTables.extra.css" rel="stylesheet">
<script src="libs/dt-core-1.13.4/js/jquery.dataTables.min.js"></script><link href="libs/nouislider-7.0.10/jquery.nouislider.min.css" rel="stylesheet">
<script src="libs/nouislider-7.0.10/jquery.nouislider.min.js"></script><link href="libs/selectize-0.12.0/selectize.bootstrap3.css" rel="stylesheet">
<script src="libs/selectize-0.12.0/selectize.min.js"></script><link href="libs/crosstalk-1.2.0/css/crosstalk.min.css" rel="stylesheet">
<script src="libs/crosstalk-1.2.0/js/crosstalk.min.js"></script><script src="libs/kePrint-0.0.1/kePrint.js"></script><link href="libs/lightable-0.0.1/lightable.css" rel="stylesheet">
<link href="libs/tabwid-1.1.3/tabwid.css" rel="stylesheet">
<script src="libs/tabwid-1.1.3/tabwid.js"></script><link href="libs/leaflet-1.3.1/leaflet.css" rel="stylesheet">
<script src="libs/leaflet-1.3.1/leaflet.js"></script><link href="libs/leafletfix-1.0.0/leafletfix.css" rel="stylesheet">
<script src="libs/proj4-2.6.2/proj4.min.js"></script><script src="libs/Proj4Leaflet-1.0.1/proj4leaflet.js"></script><link href="libs/rstudio_leaflet-1.3.1/rstudio_leaflet.css" rel="stylesheet">
<script src="libs/leaflet-binding-2.1.2/leaflet.js"></script><script src="libs/leaflet-providers-1.9.0/leaflet-providers_1.9.0.js"></script><script src="libs/leaflet-providers-plugin-2.1.2/leaflet-providers-plugin.js"></script><script src="libs/viz-1.8.2/viz.js"></script><link href="libs/DiagrammeR-styles-0.2/styles.css" rel="stylesheet">
<script src="libs/grViz-binding-1.0.10/grViz.js"></script><script src="libs/d3-4.5.0/d3.min.js"></script><script src="libs/sankey-1/sankey.js"></script><script src="libs/sankeyNetwork-binding-0.4/sankeyNetwork.js"></script><script src="libs/plotly-binding-4.10.1/plotly.js"></script><script src="libs/typedarray-0.1/typedarray.min.js"></script><link href="libs/plotly-htmlwidgets-css-2.11.1/plotly-htmlwidgets.css" rel="stylesheet">
<script src="libs/plotly-main-2.11.1/plotly-latest.min.js"></script><link href="libs/vis-9.1.0/vis-network.min.css" rel="stylesheet">
<script src="libs/vis-9.1.0/vis-network.min.js"></script><script src="libs/visNetwork-binding-2.1.2/visNetwork.js"></script><link href="libs/font-awesome-4.7.0/css/font-awesome.min.css" rel="stylesheet">
<script src="libs/plotly-basic-2.11.1/plotly-basic-2.11.1.min.js"></script><script src="libs/plotly-cartesian-2.11.1/plotly-cartesian-2.11.1.min.js"></script><script src="libs/proj4js-2.3.15/proj4.js"></script><link href="libs/highcharts-9.3.1/css/motion.css" rel="stylesheet">
<script src="libs/highcharts-9.3.1/highcharts.js"></script><script src="libs/highcharts-9.3.1/highcharts-3d.js"></script><script src="libs/highcharts-9.3.1/highcharts-more.js"></script><script src="libs/highcharts-9.3.1/modules/stock.js"></script><script src="libs/highcharts-9.3.1/modules/map.js"></script><script src="libs/highcharts-9.3.1/modules/data.js"></script><script src="libs/highcharts-9.3.1/modules/exporting.js"></script><script src="libs/highcharts-9.3.1/modules/offline-exporting.js"></script><script src="libs/highcharts-9.3.1/modules/drilldown.js"></script><script src="libs/highcharts-9.3.1/modules/item-series.js"></script><script src="libs/highcharts-9.3.1/modules/overlapping-datalabels.js"></script><script src="libs/highcharts-9.3.1/modules/annotations.js"></script><script src="libs/highcharts-9.3.1/modules/export-data.js"></script><script src="libs/highcharts-9.3.1/modules/funnel.js"></script><script src="libs/highcharts-9.3.1/modules/heatmap.js"></script><script src="libs/highcharts-9.3.1/modules/treemap.js"></script><script src="libs/highcharts-9.3.1/modules/sankey.js"></script><script src="libs/highcharts-9.3.1/modules/dependency-wheel.js"></script><script src="libs/highcharts-9.3.1/modules/organization.js"></script><script src="libs/highcharts-9.3.1/modules/solid-gauge.js"></script><script src="libs/highcharts-9.3.1/modules/streamgraph.js"></script><script src="libs/highcharts-9.3.1/modules/sunburst.js"></script><script src="libs/highcharts-9.3.1/modules/vector.js"></script><script src="libs/highcharts-9.3.1/modules/wordcloud.js"></script><script src="libs/highcharts-9.3.1/modules/xrange.js"></script><script src="libs/highcharts-9.3.1/modules/tilemap.js"></script><script src="libs/highcharts-9.3.1/modules/venn.js"></script><script src="libs/highcharts-9.3.1/modules/gantt.js"></script><script src="libs/highcharts-9.3.1/modules/timeline.js"></script><script src="libs/highcharts-9.3.1/modules/parallel-coordinates.js"></script><script src="libs/highcharts-9.3.1/modules/bullet.js"></script><script src="libs/highcharts-9.3.1/modules/coloraxis.js"></script><script src="libs/highcharts-9.3.1/modules/dumbbell.js"></script><script src="libs/highcharts-9.3.1/modules/lollipop.js"></script><script src="libs/highcharts-9.3.1/modules/series-label.js"></script><script src="libs/highcharts-9.3.1/plugins/motion.js"></script><script src="libs/highcharts-9.3.1/custom/reset.js"></script><script src="libs/highcharts-9.3.1/modules/boost.js"></script><script src="libs/highchart-binding-0.9.4/highchart.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- CSS --><style type="text/css">
    
    div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  </style>
<link rel="stylesheet" href="style_bs4.css">
</head>
<body data-spy="scroll" data-target="#toc">

<div class="container-fluid">
<div class="row">
  <header class="col-sm-12 col-lg-3 sidebar sidebar-book"><a class="sr-only sr-only-focusable" href="#content">Skip to main content</a>

    <div class="d-flex align-items-start justify-content-between">
      <h1>
        <a href="index.html" title="">Le Epi R Handbook</a>
      </h1>
      <button class="btn btn-outline-primary d-lg-none ml-2 mt-1" type="button" data-toggle="collapse" data-target="#main-nav" aria-expanded="true" aria-controls="main-nav"><i class="fas fa-bars"></i><span class="sr-only">Show table of contents</span></button>
    </div>

    <div id="main-nav" class="collapse-lg">
      <form role="search">
        <input id="search" class="form-control" type="search" placeholder="Search" aria-label="Search">
</form>

      <nav aria-label="Table of contents"><h2>Table of contents</h2>
        <ul class="book-toc list-unstyled">
<li><a class="" href="index.html"></a></li>
<li class="book-part">About this book</li>
<li><a class="" href="editorial_notes.html"><span class="header-section-number">1</span> Notes techniques et choix éditoriaux</a></li>
<li><a class="" href="download_book_data.html"><span class="header-section-number">2</span> Télécharger le manuel et les données</a></li>
<li class="book-part">Basics</li>
<li><a class="" href="rbasics.html"><span class="header-section-number">3</span> R - les bases</a></li>
<li><a class="" href="transition_to_r.html"><span class="header-section-number">4</span> Transition vers R</a></li>
<li><a class="" href="suggested_packages.html"><span class="header-section-number">5</span> Paquets conseillés</a></li>
<li><a class="" href="r_projects.html"><span class="header-section-number">6</span> Projets R</a></li>
<li><a class="" href="import_export.html"><span class="header-section-number">7</span> Importer et exporter des données</a></li>
<li class="book-part">Data Management</li>
<li><a class="" href="cleaning_data.html"><span class="header-section-number">8</span> Nettoyage de données et fonctions essentielles</a></li>
<li><a class="" href="working_dates.html"><span class="header-section-number">9</span> Manipuler les dates</a></li>
<li><a class="" href="character_strings.html"><span class="header-section-number">10</span> Caractères et chaînes de caractères</a></li>
<li><a class="" href="factors.html"><span class="header-section-number">11</span> Facteurs</a></li>
<li><a class="" href="pivoting_data.html"><span class="header-section-number">12</span> Restructurer les données</a></li>
<li><a class="" href="grouping_data.html"><span class="header-section-number">13</span> Travailler sur des données groupées</a></li>
<li><a class="" href="joining_matching.html"><span class="header-section-number">14</span> Joindre des données</a></li>
<li><a class="" href="deduplication.html"><span class="header-section-number">15</span> De-duplication</a></li>
<li><a class="" href="iteration.html"><span class="header-section-number">16</span> Itération, boucles et listes</a></li>
<li class="book-part">Analysis</li>
<li><a class="" href="descriptive_tables.html"><span class="header-section-number">17</span> Tableaux descriptifs</a></li>
<li><a class="" href="stats_test.html"><span class="header-section-number">18</span> Tests statistiques simples</a></li>
<li><a class="" href="regression.html"><span class="header-section-number">19</span> Régression univariée et multivariable</a></li>
<li><a class="" href="missing_data.html"><span class="header-section-number">20</span> Données manquantes</a></li>
<li><a class="" href="standardisation.html"><span class="header-section-number">21</span> Taux standardisés</a></li>
<li><a class="" href="moving_average.html"><span class="header-section-number">22</span> Moyennes mobiles</a></li>
<li><a class="active" href="time_series.html"><span class="header-section-number">23</span> Série temporelle et détection des épidémies</a></li>
<li><a class="" href="epidemic_models.html"><span class="header-section-number">24</span> Modélisation des épidémies</a></li>
<li><a class="" href="contact_tracing.html"><span class="header-section-number">25</span> Suivi des contacts</a></li>
<li><a class="" href="survey_analysis.html"><span class="header-section-number">26</span> Analyse d’enquête</a></li>
<li><a class="" href="survival_analysis.html"><span class="header-section-number">27</span> Analyse de survie</a></li>
<li><a class="" href="gis.html"><span class="header-section-number">28</span> GIS basics</a></li>
<li class="book-part">Data Visualization</li>
<li><a class="" href="tables_presentation.html"><span class="header-section-number">29</span> Présenter avec des tables</a></li>
<li><a class="" href="ggplot_basics.html"><span class="header-section-number">30</span> Les bases de ggplot</a></li>
<li><a class="" href="ggplot_tips.html"><span class="header-section-number">31</span> Trucs et Astuces avec ggplot</a></li>
<li><a class="" href="epicurves.html"><span class="header-section-number">32</span> Courbes épidémiques</a></li>
<li><a class="" href="age_pyramid.html"><span class="header-section-number">33</span> Pyramides démographiques et échelles de Likert</a></li>
<li><a class="" href="heatmaps.html"><span class="header-section-number">34</span> Graphiques thermiques</a></li>
<li><a class="" href="diagrams.html"><span class="header-section-number">35</span> Diagrammes et schémas</a></li>
<li><a class="" href="combination_analysis.html"><span class="header-section-number">36</span> Analyse des combinaisons</a></li>
<li><a class="" href="transmission_chains.html"><span class="header-section-number">37</span> Chaînes de transmission</a></li>
<li><a class="" href="phylogenetic_trees.html"><span class="header-section-number">38</span> Les arbres phylogénétiques</a></li>
<li><a class="" href="interactive_plots.html"><span class="header-section-number">39</span> Graphiques interactifs</a></li>
<li class="book-part">Reports and dashboards</li>
<li><a class="" href="rmarkdown.html"><span class="header-section-number">40</span> Production de rapports avec R Markdown</a></li>
<li><a class="" href="reportfactory.html"><span class="header-section-number">41</span> Organisation des rapports de routine</a></li>
<li><a class="" href="dashboards.html"><span class="header-section-number">42</span> Tableaux de bord avec R Markdown</a></li>
<li><a class="" href="shiny.html"><span class="header-section-number">43</span> Tableaux de bord avec Shiny</a></li>
<li class="book-part">Miscellaneous</li>
<li><a class="" href="writing_functions.html"><span class="header-section-number">44</span> Fonctions d’écriture</a></li>
<li><a class="" href="directories.html"><span class="header-section-number">45</span> Interactions avec les répertoires</a></li>
<li><a class="" href="collaboration.html"><span class="header-section-number">46</span> Contrôle de version et collaboration avec Git et Github</a></li>
<li><a class="" href="errors.html"><span class="header-section-number">47</span> Erreurs fréquentes</a></li>
<li><a class="" href="help.html"><span class="header-section-number">48</span> Obtenir de l’aide</a></li>
<li><a class="" href="network_drives.html"><span class="header-section-number">49</span> R sur les lecteurs réseau</a></li>
<li><a class="" href="data_table.html"><span class="header-section-number">50</span> Tableau de données</a></li>
</ul>

        <div class="book-extra">
          
        </div>
      </nav>
</div>
  </header><main class="col-sm-12 col-md-9 col-lg-7" id="content"><div id="time_series" class="section level1" number="23">
<h1>
<span class="header-section-number">23</span> Série temporelle et détection des épidémies<a class="anchor" aria-label="anchor" href="#time_series"><i class="fas fa-link"></i></a>
</h1>
<!-- ======================================================= -->
<div id="aperçu-1" class="section level2" number="23.1">
<h2>
<span class="header-section-number">23.1</span> Aperçu<a class="anchor" aria-label="anchor" href="#aper%C3%A7u-1"><i class="fas fa-link"></i></a>
</h2>
<p>Cet onglet démontre l’utilisation de plusieurs paquets pour l’analyse des séries temporelles. Il s’appuie principalement sur les paquets de la famille <a href="https://tidyverts.org/"><strong>tidyverts</strong></a> mais utilise également le paquet RECON <a href="https://github.com/reconhub/trending"><strong>trending</strong></a> pour ajuster des modèles qui sont plus appropriés à l’épidémiologie des maladies infectieuses.</p>
<p>Notez que dans l’exemple ci-dessous, nous utilisons un ensemble de données provenant du paquet <strong>surveillance</strong>. sur Campylobacter en Allemagne (voir le <a href="#data_used">chapitre sur les données</a>, du manuel pour plus de détails). Cependant, si vous vouliez exécuter le même code sur un ensemble de données avec plusieurs pays ou d’autres strates, il y a un exemple de code pour cela dans le fichier <a href="https://github.com/R4EPI/epitsa">r4epis github repo</a>.</p>
<p>Les sujets abordés sont les suivants :</p>
<ol style="list-style-type: decimal">
<li>Données de séries temporelles</li>
<li>Analyse descriptive</li>
<li>Régressions ajustées</li>
<li>Relation de deux séries temporelles</li>
<li>Détection de l’épidémie</li>
<li>Séries chronologiques interrompues</li>
</ol>
<!-- ======================================================= -->
</div>
<div id="préparation-6" class="section level2" number="23.2">
<h2>
<span class="header-section-number">23.2</span> Préparation<a class="anchor" aria-label="anchor" href="#pr%C3%A9paration-6"><i class="fas fa-link"></i></a>
</h2>
<div id="paquets" class="section level3 unnumbered">
<h3>Paquets<a class="anchor" aria-label="anchor" href="#paquets"><i class="fas fa-link"></i></a>
</h3>
<p>Ce morceau de code montre le chargement des paquets nécessaires aux analyses. Dans ce manuel, nous mettons l’accent sur <code><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load()</a></code> de <strong>pacman</strong>, qui installe le paquet si nécessaire <em>et</em> le charge pour l’utiliser. Vous pouvez également charger des paquets avec <code><a href="https://rdrr.io/r/base/library.html">library()</a></code> depuis <strong>base</strong> R. Voir la page sur <a href="rbasics.html#rbasics">bases de R</a> pour plus d’informations sur les paquets R.</p>
<div class="sourceCode" id="cb1101"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu">pacman</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/pacman/man/p_load.html">p_load</a></span><span class="op">(</span><span class="va">rio</span>, <span class="co"># Importation du fichier</span></span>
<span>               <span class="va">here</span>, <span class="co"># Localisation de fichiers</span></span>
<span>               <span class="va">tidyverse</span>, <span class="co"># gestion des données + graphiques ggplot2</span></span>
<span>               <span class="va">tsibble</span>, <span class="co"># gère les ensembles de données de séries temporelles</span></span>
<span>               <span class="va">slider</span>, <span class="co"># pour calculer les moyennes mobiles</span></span>
<span>               <span class="va">imputeTS</span>, <span class="co"># pour remplir les valeurs manquantes</span></span>
<span>               <span class="va">feasts</span>, <span class="co"># pour la décomposition des séries temporelles et l'autocorrélation</span></span>
<span>               <span class="va">forecast</span>, <span class="co"># ajustement des termes sin et cosin aux données (note : doit être chargé après feasts)</span></span>
<span>               <span class="va">trending</span>, <span class="co"># ajustement et évaluation des modèles </span></span>
<span>               <span class="va">tmaptools</span>, <span class="co"># pour obtenir des géocoordonnées (lon/lat) à partir de noms de lieux</span></span>
<span>               <span class="va">ecmwfr</span>, <span class="co"># pour interagir avec l'API CDS de copernicus sateliate</span></span>
<span>               <span class="va">stars</span>, <span class="co"># pour lire les fichiers .nc (données climatiques)</span></span>
<span>               <span class="va">units</span>, <span class="co"># pour définir les unités de mesure (données climatiques)</span></span>
<span>               <span class="va">yardstick</span>, <span class="co"># pour l'examen de la précision du modèle</span></span>
<span>               <span class="va">surveillance</span> <span class="co"># pour la détection des aberrations</span></span>
<span>               <span class="op">)</span></span></code></pre></div>
</div>
<div id="chargement-des-données" class="section level3 unnumbered">
<h3>Chargement des données<a class="anchor" aria-label="anchor" href="#chargement-des-donn%C3%A9es"><i class="fas fa-link"></i></a>
</h3>
<p>Vous pouvez télécharger toutes les données utilisées dans ce manuel en suivant les instructions de la page <a href="download_book_data.html#download_book_data">Télécharger le manuel et les données</a>.</p>
<p>L’ensemble de données d’exemple utilisé dans cette section est le décompte hebdomadaire des cas de campylobacter signalés en Allemagne entre 2001 et 2011. <a href="https://github.com/epirhandbook/Epi_R_handbook/raw/master/data/time_series/campylobacter_germany.xlsx" class="download-button">
Vous pouvez cliquer ici pour télécharger<span> ce fichier de données (.xlsx).</span></a>.</p>
<p>Cet ensemble de données est une version réduite de l’ensemble de données disponible dans le paquet <a href="https://cran.r-project.org/web/packages/surveillance/"><strong>surveillance</strong></a> (pour plus de détails, chargez le paquet surveillance et voyez <code>?campyDE</code>)</p>
<p>Importez ces données avec la fonction <code><a href="https://rdrr.io/pkg/rio/man/import.html">import()</a></code> du paquet <strong>rio</strong> (elle gère de nombreux types de fichiers comme .xlsx, .csv, .rds - voir la page <a href="import_export.html#import_export">Importation et exportation</a> pour plus de détails).</p>
<div class="sourceCode" id="cb1102"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Importez les comptes dans R</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu">rio</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/rio/man/import.html">import</a></span><span class="op">(</span><span class="st">"campylobacter_germany.xlsx"</span><span class="op">)</span></span></code></pre></div>
<p>Les 10 premières lignes des comptages sont affichées ci-dessous.</p>
<div class="datatables html-widget html-fill-item-overflow-hidden html-fill-item" id="htmlwidget-a662f6065087583f864b" style="width:100%;height:auto;"></div>
<script type="application/json" data-for="htmlwidget-a662f6065087583f864b">{"x":{"filter":"none","vertical":false,"data":[["2001-12-31T00:00:00Z","2002-01-07T00:00:00Z","2002-01-14T00:00:00Z","2002-01-21T00:00:00Z","2002-01-28T00:00:00Z","2002-02-04T00:00:00Z","2002-02-11T00:00:00Z","2002-02-18T00:00:00Z","2002-02-25T00:00:00Z","2002-03-04T00:00:00Z"],[514,913,1023,887,815,792,803,807,692,705]],"container":"<table class=\"white-space: nowrap\">\n  <thead>\n    <tr>\n      <th>date<\/th>\n      <th>case<\/th>\n    <\/tr>\n  <\/thead>\n<\/table>","options":{"pageLength":5,"scrollX":true,"columnDefs":[{"className":"dt-right","targets":1}],"order":[],"autoWidth":false,"orderClasses":false,"lengthMenu":[5,10,25,50,100]},"selection":{"mode":"multiple","selected":null,"target":"row","selectable":null}},"evals":[],"jsHooks":[]}</script>
</div>
<div id="nettoyer-les-données-1" class="section level3 unnumbered">
<h3>Nettoyer les données<a class="anchor" aria-label="anchor" href="#nettoyer-les-donn%C3%A9es-1"><i class="fas fa-link"></i></a>
</h3>
<p>Le code ci-dessous s’assure que la colonne de date est dans le format approprié.
Pour cet onglet, nous utiliserons le package <strong>tsibble</strong> et donc la fonction <code>yearweek</code> sera utilisée pour créer une variable de semaine calendaire. Il existe plusieurs autres façons de le faire (voir la page <a href="working_dates.html#working_dates">Manipuler les dates</a> pour plus de détails), mais pour les séries temporelles, il est préférable de rester dans un seul cadre (<strong>tsibble</strong>).</p>
<div class="sourceCode" id="cb1103"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## s'assurer que la colonne date est dans le format approprié</span></span>
<span><span class="va">counts</span><span class="op">$</span><span class="va">date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">date</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## créer une variable de semaine calendaire </span></span>
<span><span class="co">## adapter les définitions ISO des semaines commençant un lundi</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>epiweek <span class="op">=</span> <span class="fu">yearweek</span><span class="op">(</span><span class="va">date</span>, week_start <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
</div>
<div id="télécharger-les-données-climatiques" class="section level3 unnumbered">
<h3>Télécharger les données climatiques<a class="anchor" aria-label="anchor" href="#t%C3%A9l%C3%A9charger-les-donn%C3%A9es-climatiques"><i class="fas fa-link"></i></a>
</h3>
<p>Dans la partie <em>relation de deux séries temporelles</em> de cette page, nous allons comparer le nombre de cas de campylobacter aux données climatiques.</p>
<p>Les données climatiques de n’importe quel endroit du monde peuvent être téléchargées à partir du satellite Copernicus de l’UE. Il ne s’agit pas de mesures exactes, mais de données basées sur un modèle (similaire à l’interpolation), mais l’avantage est une couverture horaire globale ainsi que des prévisions.</p>
<p>Vous pouvez télécharger chacun de ces fichiers de données climatiques à partir de la page <a href="download_book_data.html#download_book_data">Télécharger le manuel et les données</a>.</p>
<p>Pour les besoins de la démonstration, nous allons présenter le code R permettant d’utiliser le paquet <strong>ecmwfr</strong> pour extraire ces données du magasin de données climatiques Copernicus Climate Data Store. Vous devrez créer un compte gratuit pour que cela fonctionne. Le site Web du paquet contient un <a href="https://github.com/bluegreen-labs/ecmwfr#use-copernicus-climate-data-store-cds">demo utile</a> sur la manière de procéder. Vous trouverez ci-dessous un exemple de code expliquant comment procéder, une fois que vous les clés API appropriées. Vous devez remplacer les X ci-dessous par les identifiants de votre compte. Vous devrez télécharger une année de données à la fois, sinon le serveur s’arrête.</p>
<p>Si vous n’êtes pas sûr des coordonnées d’un lieu pour lequel vous voulez télécharger des données, vous pouvez utiliser le paquet <strong>tmaptools</strong> pour extraire les coordonnées des cartes routières ouvertes. Une autre option est le paquet <a href="https://github.com/rCarto/photon"><strong>photon</strong></a>
mais il n’a pas encore été publié sur CRAN. <strong>photon</strong> fournit plus de données contextuelles lorsqu’il y a plusieurs correspondances pour votre recherche.</p>
<div class="sourceCode" id="cb1104"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## récupérer les coordonnées de l'emplacement</span></span>
<span><span class="va">coords</span> <span class="op">&lt;-</span> <span class="fu">geocode_OSM</span><span class="op">(</span><span class="st">"Germany"</span>, geometry <span class="op">=</span> <span class="st">"point"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## rassembler les long/lats dans un format pour les requêtes ERA-5 (bounding box) </span></span>
<span><span class="co">## (comme on ne veut qu'un seul point, on peut répéter les coordonnées)</span></span>
<span><span class="va">request_coords</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_glue.html">str_glue_data</a></span><span class="op">(</span><span class="va">coords</span><span class="op">$</span><span class="va">coords</span>, <span class="st">"{y}/{x}/{y}/{x}"</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## Extraction des données modélisées à partir du satellite copernicus (réanalyse ERA-5)</span></span>
<span><span class="co">## https://cds.climate.copernicus.eu/cdsapp#!/software/app-era5-explorer?tab=app</span></span>
<span><span class="co">## https://github.com/bluegreen-labs/ecmwfr</span></span>
<span></span>
<span><span class="co">## Configurer la clé pour les données météo </span></span>
<span><span class="fu">wf_set_key</span><span class="op">(</span>user <span class="op">=</span> <span class="st">"XXXXX"</span>,</span>
<span>           key <span class="op">=</span> <span class="st">"XXXXXXXXX-XXXX-XXXX-XXXX-XXXXXX-XXXXXXXXX"</span>,</span>
<span>           service <span class="op">=</span> <span class="st">"cds"</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## Exécution pour chaque année d'intérêt (sinon le serveur s'arrête)</span></span>
<span><span class="kw">for</span> <span class="op">(</span><span class="va">i</span> <span class="kw">in</span> <span class="fl">2002</span><span class="op">:</span><span class="fl">2011</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">## construire une requête </span></span>
<span>  <span class="co">## voir ici pour savoir comment faire : https://bluegreen-labs.github.io/ecmwfr/articles/cds_vignette.html#the-request-syntax</span></span>
<span>  <span class="co">## changer la requête en une liste en utilisant le bouton addin ci-dessus (python to list)</span></span>
<span>  <span class="co">## La cible est le nom du fichier de sortie ! !!</span></span>
<span>   <span class="va">request</span> <span class="op">&lt;-</span> <span class="va">request</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>    product_type <span class="op">=</span> <span class="st">"reanalysis"</span>,</span>
<span>    format <span class="op">=</span> <span class="st">"netcdf"</span>,</span>
<span>    variable <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"2m_temperature"</span>, <span class="st">"total_precipitation"</span><span class="op">)</span>,</span>
<span>    year <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="va">i</span><span class="op">)</span>,</span>
<span>    month <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"01"</span>, <span class="st">"02"</span>, <span class="st">"03"</span>, <span class="st">"04"</span>, <span class="st">"05"</span>, <span class="st">"06"</span>, <span class="st">"07"</span>, <span class="st">"08"</span>, <span class="st">"09"</span>, <span class="st">"10"</span>, <span class="st">"11"</span>, <span class="st">"12"</span><span class="op">)</span>,</span>
<span>    day <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"01"</span>, <span class="st">"02"</span>, <span class="st">"03"</span>, <span class="st">"04"</span>, <span class="st">"05"</span>, <span class="st">"06"</span>, <span class="st">"07"</span>, <span class="st">"08"</span>, <span class="st">"09"</span>, <span class="st">"10"</span>, <span class="st">"11"</span>, <span class="st">"12"</span>,</span>
<span>            <span class="st">"13"</span>, <span class="st">"14"</span>, <span class="st">"15"</span>, <span class="st">"16"</span>, <span class="st">"17"</span>, <span class="st">"18"</span>, <span class="st">"19"</span>, <span class="st">"20"</span>, <span class="st">"21"</span>, <span class="st">"22"</span>, <span class="st">"23"</span>, <span class="st">"24"</span>,</span>
<span>            <span class="st">"25"</span>, <span class="st">"26"</span>, <span class="st">"27"</span>, <span class="st">"28"</span>, <span class="st">"29"</span>, <span class="st">"30"</span>, <span class="st">"31"</span><span class="op">)</span>,</span>
<span>    time <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"00:00"</span>, <span class="st">"01:00"</span>, <span class="st">"02:00"</span>, <span class="st">"03:00"</span>, <span class="st">"04:00"</span>, <span class="st">"05:00"</span>, <span class="st">"06:00"</span>, <span class="st">"07:00"</span>,</span>
<span>             <span class="st">"08:00"</span>, <span class="st">"09:00"</span>, <span class="st">"10:00"</span>, <span class="st">"11:00"</span>, <span class="st">"12:00"</span>, <span class="st">"13:00"</span>, <span class="st">"14:00"</span>, <span class="st">"15:00"</span>,</span>
<span>             <span class="st">"16:00"</span>, <span class="st">"17:00"</span>, <span class="st">"18:00"</span>, <span class="st">"19:00"</span>, <span class="st">"20:00"</span>, <span class="st">"21:00"</span>, <span class="st">"22:00"</span>, <span class="st">"23:00"</span><span class="op">)</span>,</span>
<span>    area <span class="op">=</span> <span class="va">request_coords</span>,</span>
<span>    dataset_short_name <span class="op">=</span> <span class="st">"reanalysis-era5-single-levels"</span>,</span>
<span>    target <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span><span class="op">(</span><span class="st">"germany_weather"</span>, <span class="va">i</span>, <span class="st">".nc"</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">### Télécharger le fichier et le stocker dans le répertoire de travail actuel.</span></span>
<span>  <span class="va">file</span> <span class="op">&lt;-</span> <span class="fu">wf_request</span><span class="op">(</span>user <span class="op">=</span> <span class="st">"XXXXX"</span>, <span class="co"># ID utilisateur (pour l'authentification)</span></span>
<span>                     request <span class="op">=</span> <span class="va">request</span>, <span class="co"># la requête</span></span>
<span>                     transfer <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co"># télécharger le fichier</span></span>
<span>                     path <span class="op">=</span> <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"Weather"</span><span class="op">)</span><span class="op">)</span> <span class="co">## chemin pour sauvegarder les données</span></span>
<span>  <span class="op">}</span></span></code></pre></div>
</div>
<div id="charger-les-données-climatiques" class="section level3 unnumbered">
<h3>Charger les données climatiques<a class="anchor" aria-label="anchor" href="#charger-les-donn%C3%A9es-climatiques"><i class="fas fa-link"></i></a>
</h3>
<p>Que vous ayez téléchargé les données climatiques via notre manuel ou que vous ayez utilisé le code ci-dessus, vous devriez maintenant avoir 10 ans de fichiers de données climatiques “.nc” stockés dans le même dossier sur votre ordinateur.</p>
<p>Utilisez le code ci-dessous pour importer ces fichiers dans R avec le paquet <strong>stars</strong>.</p>
<div class="sourceCode" id="cb1105"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## définir le chemin vers le dossier météo </span></span>
<span><span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.files.html">list.files</a></span><span class="op">(</span></span>
<span>  <span class="fu">here</span><span class="fu">::</span><span class="fu"><a href="https://here.r-lib.org//reference/here.html">here</a></span><span class="op">(</span><span class="st">"data"</span>, <span class="st">"time_series"</span>, <span class="st">"weather"</span><span class="op">)</span>, <span class="co"># remplacer par votre propre chemin de fichier </span></span>
<span>  full.names <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## ne garder que ceux qui ont le nom courant d'intérêt </span></span>
<span><span class="va">file_paths</span> <span class="op">&lt;-</span> <span class="va">file_paths</span><span class="op">[</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">file_paths</span>, <span class="st">"germany"</span><span class="op">)</span><span class="op">]</span></span>
<span></span>
<span><span class="co">## lire tous les fichiers en tant qu'objet stars </span></span>
<span><span class="va">data</span> <span class="op">&lt;-</span> <span class="fu">stars</span><span class="fu">::</span><span class="fu"><a href="https://r-spatial.github.io/stars/reference/read_stars.html">read_stars</a></span><span class="op">(</span><span class="va">file_paths</span><span class="op">)</span></span></code></pre></div>
<pre><code>## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp, 
## t2m, tp,</code></pre>
<p>Une fois que ces fichiers ont été importés en tant qu’objet <code>data</code>, nous allons les convertir en un cadre de données.</p>
<div class="sourceCode" id="cb1107"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## conversion en cadre de données </span></span>
<span><span class="va">temp_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## ajouter des variables et corriger les unités</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## créer une variable de semaine calendaire </span></span>
<span>    epiweek <span class="op">=</span> <span class="fu">tsibble</span><span class="fu">::</span><span class="fu"><a href="https://tsibble.tidyverts.org/reference/year-week.html">yearweek</a></span><span class="op">(</span><span class="va">time</span><span class="op">)</span>, </span>
<span>    <span class="co">## créer une variable de date (début de la semaine calendaire)</span></span>
<span>    date <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">epiweek</span><span class="op">)</span>,</span>
<span>    <span class="co">## changer la température de kelvin en celsius</span></span>
<span>    t2m <span class="op">=</span> <span class="fu">set_units</span><span class="op">(</span><span class="va">t2m</span>, <span class="va">celsius</span><span class="op">)</span>, </span>
<span>    <span class="co">## changer les précipitations de mètres en millimètres </span></span>
<span>    tp <span class="op">=</span> <span class="fu">set_units</span><span class="op">(</span><span class="va">tp</span>, <span class="va">mm</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## regrouper par semaine (en gardant la date aussi)</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">date</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## obtenir la moyenne par semaine</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span>t2m <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">t2m</span><span class="op">)</span><span class="op">)</span>, </span>
<span>            tp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">tp</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
</div>
<div id="données-de-séries-temporelles" class="section level2" number="23.3">
<h2>
<span class="header-section-number">23.3</span> Données de séries temporelles<a class="anchor" aria-label="anchor" href="#donn%C3%A9es-de-s%C3%A9ries-temporelles"><i class="fas fa-link"></i></a>
</h2>
<p>Il existe un certain nombre de paquets différents pour structurer et traiter les données de données de séries temporelles. Comme nous l’avons dit, nous nous concentrerons sur la famille de paquets <strong>tidyverts</strong> et nous utiliserons donc le paquet <strong>tsibble</strong> pour définir notre objet série temporelle. Avoir un ensemble de données défini comme un objet de série temporelle, il est beaucoup plus facile de structurer notre analyse.</p>
<p>Pour ce faire, nous utilisons la fonction <code>tsibble()</code> et spécifions l’“index”, c’est-à-dire la variable spécifiant l’unité de temps qui nous intéresse. Dans notre cas, il s’agit de la variable <code>epiweek</code>.</p>
<p>Si nous avions un ensemble de données avec des comptages hebdomadaires par province, par exemple, nous pourrions également spécifier la variable de regroupement en utilisant l’argument <code>key =</code>. Cela nous permettrait d’effectuer une analyse pour chaque groupe.</p>
<div class="sourceCode" id="cb1108"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Définir un objet de série temporelle </span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu">tsibble</span><span class="op">(</span><span class="va">counts</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span></span></code></pre></div>
<p>En regardant <code>class(counts)</code>, on constate qu’en plus d’être un cadre de données ordonné (“tbl_df”, “tbl”, “data.frame”), il possède les propriétés supplémentaires d’un cadre de données de série temporelle (“tbl_ts”).</p>
<p>Vous pouvez jeter un coup d’oil rapide à vos données en utilisant <strong>ggplot2</strong>. Nous voyons sur le graphique que qu’il existe un modèle saisonnier clair, et qu’il n’y a pas de manques. Cependant, il semble y avoir un problème avec la déclaration au début de chaque année, dans la dernière semaine de l’année, puis augmentent pour la première semaine de l’année suivante.</p>
<div class="sourceCode" id="cb1109"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## tracer un graphique linéaire des cas par semaine</span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">case</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/basic_plot-1.png" width="672"></div>
<p><span style="color : red ;"><strong><em>ATTENTION:</em></strong> La plupart des ensembles de données ne sont pas aussi propres que cet exemple. Vous devrez vérifier les doublons et les valuers qui manques comme ci-dessous. </span></p>
<!-- ======================================================= -->
<div id="duplicates" class="section level3 unnumbered">
<h3>Duplicates<a class="anchor" aria-label="anchor" href="#duplicates"><i class="fas fa-link"></i></a>
</h3>
<p><strong>tsibble</strong> n’autorise pas les observations en double. Ainsi, chaque ligne devra être
unique, ou unique au sein du groupe (variable <code>key</code>). Le paquet a quelques fonctions qui aident à identifier les doublons. Celles-ci incluent <code>are_duplicated()</code> qui vous donne un vecteur VRAI/FAUX indiquant si la ligne est un dupliqué, et <code>duplicates()</code> qui vous donne un cadre de données des lignes dupliquées.</p>
<p>Voir la page sur <a href="cleaning_data.html#deduplication">De-duplication</a> pour plus de détails sur la façon de sélectionner les lignes que vous voulez.</p>
<div class="sourceCode" id="cb1110"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## obtient un vecteur de VRAI/FAUX si les lignes sont des doublons</span></span>
<span><span class="fu">are_duplicated</span><span class="op">(</span><span class="va">counts</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> </span>
<span></span>
<span><span class="co">## Obtenez un cadre de données pour les lignes dupliquées. </span></span>
<span><span class="fu">duplicates</span><span class="op">(</span><span class="va">counts</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> </span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="manques" class="section level3 unnumbered">
<h3>Manques<a class="anchor" aria-label="anchor" href="#manques"><i class="fas fa-link"></i></a>
</h3>
<p>Nous avons vu lors de notre brève inspection ci-dessus qu’il n’y a pas de manques, mais nous avons aussi vu qu’il semble y avoir un problème de retard de déclaration autour du nouvel an. Une façon de résoudre ce problème pourrait être de définir ces valeurs comme manquantes, puis d’imputer les valeurs. La forme la plus simple d’imputation de séries chronologiques consiste à tracer une ligne droite entre les dernières valeurs non manquantes et les valeurs manquantes.
Pour ce faire, nous utiliserons la fonction <code>na_interpolation()</code> du package <strong>imputeTS</strong>.</p>
<p>Consultez la page <a href="missing_data.html#missing_data">Données manquantes</a> pour connaître les autres options d’imputation.</p>
<p>Une autre solution consisterait à calculer une moyenne mobile, pour essayer de pour tenter d’aplanir ces problèmes de déclaration apparents (voir la section suivante et la page sur les <a href="moving_average.html#moving_average">Moyennes mobiles</a>).</p>
<div class="sourceCode" id="cb1111"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## créez une variable avec les manques au lieu des semaines avec des problèmes de déclaration.</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>case_miss <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/if_else.html">if_else</a></span><span class="op">(</span></span>
<span>          <span class="co">## si epiweek contient 52, 53, 1 ou 2</span></span>
<span>          <span class="fu"><a href="https://stringr.tidyverse.org/reference/str_detect.html">str_detect</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="st">"W51|W52|W53|W01|W02"</span><span class="op">)</span>, </span>
<span>          <span class="co">## alors définie comme manquante </span></span>
<span>          <span class="cn">NA_real_</span>, </span>
<span>          <span class="co">## sinon, conservez la valeur dans le cas</span></span>
<span>          <span class="va">case</span></span>
<span>     <span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## alternativement interpoler les manquants par une tendance linéaire </span></span>
<span><span class="co">## entre deux points adjacents les plus proches</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>case_int <span class="op">=</span> <span class="fu">imputeTS</span><span class="fu">::</span><span class="fu"><a href="https://SteffenMoritz.github.io/imputeTS/reference/na_interpolation.html">na_interpolation</a></span><span class="op">(</span><span class="va">case_miss</span><span class="op">)</span></span>
<span>         <span class="op">)</span></span>
<span></span>
<span><span class="co">## pour vérifier quelles valeurs ont été imputées par rapport à l'original.</span></span>
<span><span class="fu">ggplot_na_imputations</span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_miss</span>, <span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## faire un graphique traditionnel (avec des axes noirs et un fond blanc)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/missings-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
<div id="analyse-descriptive" class="section level2" number="23.4">
<h2>
<span class="header-section-number">23.4</span> Analyse descriptive<a class="anchor" aria-label="anchor" href="#analyse-descriptive"><i class="fas fa-link"></i></a>
</h2>
<!-- ======================================================= -->
<div id="timeseries_moving" class="section level3 unnumbered">
<h3>Moyennes mobiles<a class="anchor" aria-label="anchor" href="#timeseries_moving"><i class="fas fa-link"></i></a>
</h3>
<p>Si les données sont très bruyantes (les comptes sautent en haut et en bas), alors il peut être utile de calculer une moyenne mobile. Dans l’exemple ci-dessous, pour chaque semaine, nous calculons le nombre moyen de cas des quatre semaines précédentes. Cela permet de lisser les données, pour les rendre plus interprétables. Dans notre cas, cela n’apporte pas grand-chose.
Nous nous en tiendrons aux données interpolées pour la suite de l’analyse. Voir la page <a href="moving_average.html#moving_average">Moyennes mobiles</a> pour plus de détails.</p>
<div class="sourceCode" id="cb1112"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## créer une variable de moyenne mobile (traite les manques)</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>     <span class="co">## créer la variable ma_4w </span></span>
<span>     <span class="co">## glisser sur chaque ligne de la variable case</span></span>
<span>     <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>ma_4wk <span class="op">=</span> <span class="fu">slider</span><span class="fu">::</span><span class="fu"><a href="https://slider.r-lib.org/reference/slide.html">slide_dbl</a></span><span class="op">(</span><span class="va">case</span>, </span>
<span>                               <span class="co">## pour chaque ligne, calculez le nom</span></span>
<span>                               <span class="op">~</span> <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span><span class="op">(</span><span class="va">.x</span>, na.rm <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span>,</span>
<span>                               <span class="co">## utiliser les quatre semaines précédentes</span></span>
<span>                               .before <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### faire une visualisation rapide de la différence </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>     <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">ma_4wk</span><span class="op">)</span>, colour <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/moving_averages-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="périodicité" class="section level3 unnumbered">
<h3>Périodicité<a class="anchor" aria-label="anchor" href="#p%C3%A9riodicit%C3%A9"><i class="fas fa-link"></i></a>
</h3>
<p>Nous définissons ci-dessous une fonction personnalisée pour créer un périodogramme. Voir la page <a href="writing_functions.html#writing_functions">ecrire les fonctions</a> pour des informations sur la façon d’écrire des fonctions dans R.</p>
<p>Tout d’abord, la fonction est définie. Ses arguments incluent un jeu de données avec une colonne <code>counts</code>, <code>start_week =</code> qui est la première semaine du jeu de données, un nombre pour indiquer combien de périodes par an (par exemple 52, 12), et enfin le style de sortie (voir les détails dans le code ci-dessous).</p>
<div class="sourceCode" id="cb1113"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Arguments de la fonction</span></span>
<span><span class="co">#####################</span></span>
<span><span class="co">## x est un ensemble de données</span></span>
<span><span class="co">## counts est une variable avec des données de comptage ou des taux dans x </span></span>
<span><span class="co">## start_week est la première semaine de votre série de données</span></span>
<span><span class="co">## period est le nombre d'unités dans une année. </span></span>
<span><span class="co">## output indique si vous souhaitez renvoyer le périodogramme spectral ou les semaines de pointe.</span></span>
<span>  <span class="co">## "périodogramme" ou "semaines".</span></span>
<span></span>
<span><span class="co"># Définissez la fonction</span></span>
<span><span class="va">periodogram</span> <span class="op">&lt;-</span> <span class="kw">function</span><span class="op">(</span><span class="va">x</span>, </span>
<span>                        <span class="va">counts</span>, </span>
<span>                        <span class="va">start_week</span> <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2002</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                        <span class="va">period</span> <span class="op">=</span> <span class="fl">52</span>, </span>
<span>                        <span class="va">output</span> <span class="op">=</span> <span class="st">"weeks"</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span></span>
<span>    <span class="co">## s'assurer que ce n'est pas un tsibble, filtrer sur le projet et ne garder que les colonnes d'intérêt.</span></span>
<span>    <span class="va">prepare_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="va">x</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co"># prepare_data &lt;- prepare_data[prepare_data[[strata]] == j, ]</span></span>
<span>    <span class="va">prepare_data</span> <span class="op">&lt;-</span> <span class="fu">dplyr</span><span class="fu">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">prepare_data</span>, <span class="op">{</span><span class="op">{</span><span class="va">counts</span><span class="op">}</span><span class="op">}</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## créer une série temporelle "zoo" intermédiaire pour pouvoir l'utiliser avec spec.pgram</span></span>
<span>    <span class="va">zoo_cases</span> <span class="op">&lt;-</span> <span class="fu">zoo</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/zoo/man/zooreg.html">zooreg</a></span><span class="op">(</span><span class="va">prepare_data</span>, </span>
<span>                             start <span class="op">=</span> <span class="va">start_week</span>, frequency <span class="op">=</span> <span class="va">period</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## obtenir un périodogramme spectral n'utilisant pas la transformée de fourier rapide. </span></span>
<span>    <span class="va">periodo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/spec.pgram.html">spec.pgram</a></span><span class="op">(</span><span class="va">zoo_cases</span>, fast <span class="op">=</span> <span class="cn">FALSE</span>, plot <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span>    </span>
<span>    <span class="co">## retourner les semaines de pointe </span></span>
<span>    <span class="va">periodo_weeks</span> <span class="op">&lt;-</span> <span class="fl">1</span> <span class="op">/</span> <span class="va">periodo</span><span class="op">$</span><span class="va">freq</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/order.html">order</a></span><span class="op">(</span><span class="op">-</span><span class="va">periodo</span><span class="op">$</span><span class="va">spec</span><span class="op">)</span><span class="op">]</span> <span class="op">*</span> <span class="va">period</span></span>
<span>    </span>
<span>    <span class="kw">if</span> <span class="op">(</span><span class="va">output</span> <span class="op">==</span> <span class="st">"weeks"</span><span class="op">)</span> <span class="op">{</span></span>
<span>      <span class="va">periodo_weeks</span></span>
<span>    <span class="op">}</span> <span class="kw">else</span> <span class="op">{</span></span>
<span>      <span class="va">periodo</span></span>
<span>    <span class="op">}</span></span>
<span>    </span>
<span><span class="op">}</span></span>
<span></span>
<span><span class="co">## obtenir le périodogramme spectral pour extraire les semaines avec les fréquences les plus élevées </span></span>
<span><span class="co">## (vérification de la saisonnalité) </span></span>
<span><span class="va">periodo</span> <span class="op">&lt;-</span> <span class="fu">periodogram</span><span class="op">(</span><span class="va">counts</span>, </span>
<span>                       <span class="va">case_int</span>, </span>
<span>                       start_week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2002</span>, <span class="fl">1</span><span class="op">)</span>,</span>
<span>                       output <span class="op">=</span> <span class="st">"periodogram"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Tirez le spectre et la fréquence dans un cadre de données pour le tracé.</span></span>
<span><span class="va">periodo</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">periodo</span><span class="op">$</span><span class="va">freq</span>, <span class="va">periodo</span><span class="op">$</span><span class="va">spec</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Tracez un périodogramme montrant la périodicité la plus fréquente. </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">periodo</span>, </span>
<span>                <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="fl">1</span><span class="op">/</span><span class="op">(</span><span class="va">periodo.freq</span><span class="op">/</span><span class="fl">52</span><span class="op">)</span>, y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html">log</a></span><span class="op">(</span><span class="va">periodo.spec</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Period (weeks)"</span>, y <span class="op">=</span> <span class="st">"Log(density)"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/periodogram-1.png" width="672"></div>
<div class="sourceCode" id="cb1114"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## obtenir un vecteur semaines dans l'ordre croissant </span></span>
<span><span class="va">peak_weeks</span> <span class="op">&lt;-</span> <span class="fu">periodogram</span><span class="op">(</span><span class="va">counts</span>, </span>
<span>                          <span class="va">case_int</span>, </span>
<span>                          start_week <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="fl">2002</span>, <span class="fl">1</span><span class="op">)</span>, </span>
<span>                          output <span class="op">=</span> <span class="st">"weeks"</span><span class="op">)</span></span></code></pre></div>
<p><span style="color : black ;"><strong><em>ATTENTION:</em></strong> Il est possible d’utiliser les semaines ci-dessus pour les ajouter aux termes sin et cosinus, cependant nous utiliserons une fonction pour générer ces termes (voir la section régression ci-dessous) </span>.</p>
<!-- ======================================================= -->
</div>
<div id="décomposition" class="section level3 unnumbered">
<h3>Décomposition<a class="anchor" aria-label="anchor" href="#d%C3%A9composition"><i class="fas fa-link"></i></a>
</h3>
<p>La décomposition classique est utilisée pour décomposer une série temporelle en plusieurs parties, qui lorsqu’elles sont prises ensemble constituent le modèle que vous voyez.</p>
<p>Ces différentes parties sont :</p>
<ul>
<li>La tendance-cycle (la direction à long terme des données)<br>
</li>
<li>La saisonnalité (motifs répétitifs)<br>
</li>
<li>L’aléatoire (ce qui reste après avoir retiré la tendance et la saison).</li>
</ul>
<div class="sourceCode" id="cb1115"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Décomposition de l'ensemble de données counts </span></span>
<span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## en utilisant un modèle additif de décomposition classique</span></span>
<span>  <span class="fu">model</span><span class="op">(</span><span class="fu">classical_decomposition</span><span class="op">(</span><span class="va">case_int</span>, type <span class="op">=</span> <span class="st">"additive"</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## extraire les informations importantes du modèle</span></span>
<span>  <span class="fu">components</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## générer un graphique </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/decomposition-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="autocorrélation" class="section level3 unnumbered">
<h3>Autocorrélation<a class="anchor" aria-label="anchor" href="#autocorr%C3%A9lation"><i class="fas fa-link"></i></a>
</h3>
<p>L’autocorrélation vous renseigne sur la relation entre les comptes de chaque semaine et les semaines qui la précèdent (appelées décalages).</p>
<p>En utilisant la fonction <code>ACF()</code>, nous pouvons produire un graphique qui nous montre un certain nombre de lignes pour la relation à différents décalages. Si le décalage est de 0 (x = 0), cette ligne sera toujours égale à 1, car elle montre la relation entre les deux. La première ligne illustrée ici (x = 1) montre la relation entre chaque observation et l’observation qui la précède (décalage de 1), la seconde montre la relation entre chaque observation et l’avant-dernière (décalage de 2) et ainsi de suite jusqu’à un décalage de 52 qui montre la relation entre chaque observation et l’observation d’un an (52 semaines avant).</p>
<p>L’utilisation de la fonction <code>PACF()</code> (pour l’autocorrélation partielle) montre le même type de relation, mais ajustée pour toutes les autres semaines intermédiaires. Ceci est moins informatif pour déterminer la périodicité.</p>
<div class="sourceCode" id="cb1116"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## en utilisant l'ensemble de données counts</span></span>
<span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## calculer l'autocorrélation en utilisant une année complète de lags</span></span>
<span>  <span class="fu">ACF</span><span class="op">(</span><span class="va">case_int</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## afficher un graphique</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/autocorrelation-1.png" width="672"></div>
<div class="sourceCode" id="cb1117"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## en utilisant l'ensemble de données counts </span></span>
<span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## calculer l'autocorrélation partielle en utilisant une année complète de décalages</span></span>
<span>  <span class="fu">PACF</span><span class="op">(</span><span class="va">case_int</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## Afficher un graphique</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/autocorrelation-2.png" width="672"></div>
<p>Vous pouvez tester formellement l’hypothèse nulle d’indépendance d’une série temporelle (c’est à dire qu’elle n’est pas autocorrélée) en utilisant le test de Ljung-Box (dans le paquet <strong>stats</strong>). Une valeur p significative suggère qu’il existe une autocorrélation dans les données.</p>
<div class="sourceCode" id="cb1118"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Test d'indépendance </span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  counts$case_int
## X-squared = 462.65, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="ajustement-des-régressions" class="section level2" number="23.5">
<h2>
<span class="header-section-number">23.5</span> Ajustement des régressions<a class="anchor" aria-label="anchor" href="#ajustement-des-r%C3%A9gressions"><i class="fas fa-link"></i></a>
</h2>
<p>Il est possible d’ajuster un grand nombre de régressions différentes à une série temporelle, Cependant, nous allons montrer ici comment ajuster une régression binomiale négative, c’est souvent la plus appropriée pour les données de comptage dans les maladies infectieuses.</p>
<!-- ======================================================= -->
<div id="termes-de-fourier" class="section level3 unnumbered">
<h3>Termes de Fourier<a class="anchor" aria-label="anchor" href="#termes-de-fourier"><i class="fas fa-link"></i></a>
</h3>
<p>Les termes de Fourier sont l’équivalent des courbes sin et cosin. La différence est que ceux-ci sont ajustés en fonction de la recherche de la combinaison de courbes la plus appropriée pour expliquervos données.<br>
Si vous n’ajustez qu’un seul terme de Fourier, cela équivaudrait à ajuster une courbe sin et un cosin pour le décalage le plus fréquent de votre périodogramme (dans notre cas 52 semaines). Nous utilisons la fonction <code>fourier()</code> du paquet <strong>forecast</strong>.</p>
<p>Dans le code ci-dessous, nous assignons en utilisant le <code>$</code>, car <code>fourier()</code> renvoie deux colonnes (une pour le sin et une pour le cosin) et celles-ci sont ajoutées à l’ensemble de données sous forme de liste, appelée “fourier”. Mais cette liste peut ensuite être utilisée comme une variable normale dans une régression.</p>
<div class="sourceCode" id="cb1120"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## ajout des termes de fourier en utilisant les variables epiweek et case_int</span></span>
<span><span class="va">counts</span><span class="op">$</span><span class="va">fourier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">counts</span>, <span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">fourier</span><span class="op">(</span>K <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="binomiale-négative" class="section level3 unnumbered">
<h3>Binomiale négative<a class="anchor" aria-label="anchor" href="#binomiale-n%C3%A9gative"><i class="fas fa-link"></i></a>
</h3>
<p>Il est possible d’ajuster des régressions en utilisant les fonctions <strong>stats</strong> ou <strong>MASS</strong> de base (par exemple, <code><a href="https://rdrr.io/r/stats/lm.html">lm()</a></code>, <code><a href="https://rdrr.io/r/stats/glm.html">glm()</a></code> et <code>glm.nb()</code>). Cependant, nous utiliserons celles du paquet <strong>trending</strong>, car cela permet de calculer les intervalles de confiance et de prédictionconfiance et les intervalles de prédiction appropriés (qui ne sont pas disponibles autrement). La syntaxe est la même, et vous spécifiez une variable de résultat puis un tilde (~) puis vous ajoutez vos diverses variables d’exposition d’intérêt séparées par un plus (+).</p>
<p>L’autre différence est que nous définissons d’abord le modèle et ensuite <code>fit()</code> aux données. Ceci est utile car cela permet de comparer plusieurs modèles différents avec la même syntaxe.</p>
<p><span style="color : darkgreen ;"><strong><em>ATTENTION:</em></strong> Si vous vouliez utiliser des taux, plutôt que des comptes, vous pourriez inclure la variable population comme terme de décalage logarithmique, en ajoutant <code>offset(log(population)</code>. Vous auriez alors besoin de définir la population à 1, avant d’utiliser <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> afin de produire un taux. </span></p>
<p><span style="color : darkgreen ;"><strong><em>ATTENTION:</em></strong> Pour l’ajustement de modèles plus complexes tels que les modèles comme ARIMA ou prophète, voir le paquet <a href="https://fable.tidyverts.org/index.html"><strong>fable</strong></a>.</span></p>
<div class="sourceCode" id="cb1121"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## définissez le modèle que vous voulez ajuster (binomiale négative). </span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>  <span class="co">## définir le nombre de cas comme résultat d'intérêt</span></span>
<span>  <span class="va">case_int</span> <span class="op">~</span></span>
<span>    <span class="co">## utiliser epiweek pour tenir compte de la tendance</span></span>
<span>    <span class="va">epiweek</span> <span class="op">+</span></span>
<span>    <span class="co">## utiliser les termes de fourier pour tenir compte de la saisonnalité</span></span>
<span>    <span class="va">fourier</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## ajustez votre modèle en utilisant le jeu de données de comptage</span></span>
<span><span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### calculer les intervalles de confiance et les intervalles de prédiction </span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="va">estimate_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Tracez votre régression </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">estimate_res</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajouter une ligne pour l'estimation du modèle</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,</span>
<span>            col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajouter une bande pour les intervalles de prédiction </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, </span>
<span>                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajouter une ligne pour le nombre de cas observés</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, </span>
<span>            col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## faire un graphique traditionnel (avec des axes noirs et un fond blanc)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/nb_reg-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="résidus" class="section level3 unnumbered">
<h3>Résidus<a class="anchor" aria-label="anchor" href="#r%C3%A9sidus"><i class="fas fa-link"></i></a>
</h3>
<p>Pour voir si notre modèle s’adapte bien aux données observées, nous devons examiner les résidus. Les résidus sont la différence entre les comptes observés et les comptes estimés à partir du modèle. Nous pourrions calculer cela simplement en utilisant <code>case_int - estimate</code>, mais la fonction <code><a href="https://rdrr.io/r/stats/residuals.html">residuals()</a></code> l’extrait directement de la régression pour nous.</p>
<p>Ce que nous voyons ci-dessous, c’est que nous n’expliquons pas toutes les variations que nous pourrions expliquer avec le modèle. Il se peut que nous devions ajuster plus de termes de Fourier, et s’attaquer à l’amplitude. Cependant, pour cet exemple, nous allons laisser les choses telles quelles. Les graphiques montrent que notre modèle est moins bon dans les pics et les creux (lorsque les comptages sont les plus élevés et les plus bas) et qu’il est plus susceptible de sous-estimer les comptagees observés.</p>
<div class="sourceCode" id="cb1122"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## calculate the residuals </span></span>
<span><span class="va">estimate_res</span> <span class="op">&lt;-</span> <span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>resid <span class="op">=</span> <span class="va">fitted_model</span><span class="op">$</span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">$</span><span class="va">residuals</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## are the residuals fairly constant over time (if not: outbreaks? change in practice?)</span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"epiweek"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-847-1.png" width="672"></div>
<div class="sourceCode" id="cb1123"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## is there autocorelation in the residuals (is there a pattern to the error?)  </span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ACF</span><span class="op">(</span><span class="va">resid</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-847-2.png" width="672"></div>
<div class="sourceCode" id="cb1124"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## are residuals normally distributed (are under or over estimating?)  </span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">0.01</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_rug.html">geom_rug</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-847-3.png" width="672"></div>
<div class="sourceCode" id="cb1125"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## compare observed counts to their residuals </span></span>
<span>  <span class="co">## should also be no pattern </span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Fitted"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-847-4.png" width="672"></div>
<div class="sourceCode" id="cb1126"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## formally test autocorrelation of the residuals</span></span>
<span><span class="co">## H0 is that residuals are from a white-noise series (i.e. random)</span></span>
<span><span class="co">## test for independence </span></span>
<span><span class="co">## if p value significant then non-random</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="va">estimate_res</span><span class="op">$</span><span class="va">resid</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  estimate_res$resid
## X-squared = 336.25, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="relation-entre-deux-séries-temporelles" class="section level2" number="23.6">
<h2>
<span class="header-section-number">23.6</span> Relation entre deux séries temporelles<a class="anchor" aria-label="anchor" href="#relation-entre-deux-s%C3%A9ries-temporelles"><i class="fas fa-link"></i></a>
</h2>
<p>Nous examinons ici l’utilisation de données météorologiques (en particulier la température) pour expliquer le nombre de cas de campylobacter.</p>
<!-- ======================================================= -->
<div id="fusionner-des-ensembles-de-données" class="section level3 unnumbered">
<h3>Fusionner des ensembles de données<a class="anchor" aria-label="anchor" href="#fusionner-des-ensembles-de-donn%C3%A9es"><i class="fas fa-link"></i></a>
</h3>
<p>Nous pouvons fusionner nos ensembles de données à l’aide de la variable week. Pour plus d’informations sur la fusion, voir la section du manuel sur les <a href="https://epirhandbook.com/joining-data.html">joindres</a>.</p>
<div class="sourceCode" id="cb1128"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## left join so that we only have the rows already existing in counts</span></span>
<span><span class="co">## drop the date variable from temp_data (otherwise is duplicated)</span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">counts</span>, </span>
<span>                    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">temp_data</span>, <span class="op">-</span><span class="va">date</span><span class="op">)</span>,</span>
<span>                    by <span class="op">=</span> <span class="st">"epiweek"</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb1129"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## garder les variables qui nous intéressent </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">case_int</span>, <span class="va">t2m</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## Changez vos données en format long</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_longer.html">pivot_longer</a></span><span class="op">(</span></span>
<span>    <span class="co">## utiliser epiweek comme clé</span></span>
<span>    <span class="op">!</span><span class="va">epiweek</span>,</span>
<span>    <span class="co">## déplacez les noms des colonnes vers la nouvelle colonne "measure".</span></span>
<span>    names_to <span class="op">=</span> <span class="st">"measure"</span>, </span>
<span>    <span class="co">## déplacez les valeurs des cellules vers la nouvelle colonne "values".</span></span>
<span>    values_to <span class="op">=</span> <span class="st">"value"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## créer un graphique avec l'ensemble de données ci-dessus</span></span>
<span>  <span class="co">## Tracez l'epiweek sur l'axe des x et les valeurs (nombres/celsius) sur l'axe des y. </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">value</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>    <span class="co">## créez un graphique séparé pour les comptages tempérés et les comptages de cas. </span></span>
<span>    <span class="co">## laissez-les définir leurs propres axes y</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/facet_grid.html">facet_grid</a></span><span class="op">(</span><span class="va">measure</span> <span class="op">~</span> <span class="va">.</span>, scales <span class="op">=</span> <span class="st">"free_y"</span><span class="op">)</span> <span class="op">+</span></span>
<span>    <span class="co">## Tracez les deux comme une ligne</span></span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/basic_plot_bivar-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="lags-et-corrélation-croisée" class="section level3 unnumbered">
<h3>Lags et corrélation croisée<a class="anchor" aria-label="anchor" href="#lags-et-corr%C3%A9lation-crois%C3%A9e"><i class="fas fa-link"></i></a>
</h3>
<p>Pour tester formellement quelles semaines sont les plus fortement liées entre les cas et la température. Nous pouvons utiliser la fonction de corrélation croisée (<code>CCF()</code>) du paquet <strong>feasts</strong>. Vous pouvez également visualiser (plutôt que d’utiliser <code>arrange</code>) en utilisant la fonction <code><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot()</a></code>.</p>
<div class="sourceCode" id="cb1130"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## calculer la corrélation croisée entre les comptages interpolés et la température</span></span>
<span>  <span class="fu">CCF</span><span class="op">(</span><span class="va">case_int</span>, <span class="va">t2m</span>,</span>
<span>      <span class="co">## fixer le délai maximum à 52 semaines</span></span>
<span>      lag_max <span class="op">=</span> <span class="fl">52</span>, </span>
<span>      <span class="co">## retourne le coefficient de corrélation </span></span>
<span>      type <span class="op">=</span> <span class="st">"correlation"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## arange dans l'ordre décroissant du coefficient de corrélation </span></span>
<span>  <span class="co">## montre les décalages les plus associés</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/arrange.html">arrange</a></span><span class="op">(</span><span class="op">-</span><span class="va">ccf</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## montrer seulement les dix premiers </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice_head</a></span><span class="op">(</span>n <span class="op">=</span> <span class="fl">10</span><span class="op">)</span></span></code></pre></div>
<pre><code>## # A tsibble: 10 x 2 [1W]
##         lag   ccf
##    &lt;cf_lag&gt; &lt;dbl&gt;
##  1      -4W 0.749
##  2      -5W 0.745
##  3      -3W 0.735
##  4      -6W 0.729
##  5      -2W 0.727
##  6      -7W 0.704
##  7      -1W 0.695
##  8      -8W 0.671
##  9       0W 0.649
## 10      47W 0.638</code></pre>
<p>Nous voyons qu’un décalage de 4 semaines est le plus fortement corrélé, donc nous créons une variable de température décalée à inclure dans notre régression.</p>
<p><span style="color : red ;"><strong><em>ATTENTION:</em></strong> Notez que les quatre premières semaines de nos données dans la variable de température décalée sont manquantes (<code>NA</code>) - car il n’y a pas quatre
semaines précédentes pour obtenir des données. Afin d’utiliser cet ensemble de données avec la fonction <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> du paquet <strong>trending</strong>, nous devons utiliser l’argument <code>simulate_pi = FALSE</code> dans la fonction <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> plus bas. Si nous voulions utiliser l’option simulate, alors nous devons supprimer ces manques et les stocker comme un nouvel ensemble de données en ajoutant <code>drop_na(t2m_lag4)</code>. au morceau de code ci-dessous.</span></p>
<div class="sourceCode" id="cb1132"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## créer une nouvelle variable pour la température décalée de quatre semaines.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>t2m_lag4 <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/lead-lag.html">lag</a></span><span class="op">(</span><span class="va">t2m</span>, n <span class="op">=</span> <span class="fl">4</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="binomiale-négative-avec-deux-variables" class="section level3 unnumbered">
<h3>Binomiale négative avec deux variables<a class="anchor" aria-label="anchor" href="#binomiale-n%C3%A9gative-avec-deux-variables"><i class="fas fa-link"></i></a>
</h3>
<p>Nous ajustons une régression binomiale négative comme nous l’avons fait précédemment. Cette fois, nous ajoutons la variable de température retardée de quatre semaines.</p>
<p><span style="color : orange ;"><strong><em>ATTENTION:</em></strong> Notez l’utilisation de <code>simulate_pi = FALSE</code>
dans l’argument <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>. Ceci est dû au fait que le comportement par défaut de <strong>trending</strong>
est d’utiliser le paquet <strong>ciTools</strong> pour estimer un intervalle de prédiction. Cela ne fonctionne pas s’il y a des comptes <code>NA</code>, et produit également des intervalles plus granulaires.
Voir <code>?trending::predict.trending_model_fit</code> pour plus de détails. </span></p>
<div class="sourceCode" id="cb1133"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## définissez le modèle que vous voulez ajuster (binomial négatif). </span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>  <span class="co">## définir le nombre de cas comme résultat d'intérêt</span></span>
<span>  <span class="va">case_int</span> <span class="op">~</span></span>
<span>    <span class="co">## utiliser epiweek pour tenir compte de la tendance</span></span>
<span>    <span class="va">epiweek</span> <span class="op">+</span></span>
<span>    <span class="co">## utiliser les termes de fourier pour tenir compte de la saisonnalité</span></span>
<span>    <span class="va">fourier</span> <span class="op">+</span> </span>
<span>    <span class="co">## utiliser la température retardée de quatre semaines </span></span>
<span>    <span class="va">t2m_lag4</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co">## ajustez votre modèle en utilisant l'ensemble de données de comptage</span></span>
<span><span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### calculer les intervalles de confiance et les intervalles de prédiction </span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<p>Pour étudier les termes individuels, nous pouvons extraire la régression binomiale négative originale du paquet <strong>trending</strong> en utilisant <code>get_fitted_model()</code> et la passer au fonction <code>tidy()</code> du paquetage <strong>broom</strong> pour récupérer les estimations exponentielles et lesintervalles de confiance associés.</p>
<p>Ce que cela nous montre est que la température décalée, après avoir contrôlé la tendance et la saisonnalité, est similaire au nombre de cas (estimation ~ 1) et significativement associée.
Cela suggère qu’il pourrait s’agir d’une bonne variable à utiliser pour prédire le nombre de cas futurs (les prévisions climatiques étant facilement accessibles).</p>
<div class="sourceCode" id="cb1134"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## extraire la régression binomiale négative originale</span></span>
<span>  <span class="fu">get_fitted_model</span><span class="op">(</span><span class="op">)</span> <span class="co">#%&gt;% </span></span></code></pre></div>
<pre><code>## [[1]]
## 
## Call:  glm.nb(formula = case_int ~ epiweek + fourier + t2m_lag4, data = data.frame(counts), 
##     init.theta = 32.80689607, link = log)
## 
## Coefficients:
##  (Intercept)       epiweek  fourierS1-52  fourierC1-52      t2m_lag4  
##   5.82535083    0.00008464   -0.28502594   -0.19537827    0.00667157  
## 
## Degrees of Freedom: 504 Total (i.e. Null);  500 Residual
##   (4 observations deleted due to missingness)
## Null Deviance:       2015 
## Residual Deviance: 508.2     AIC: 6784</code></pre>
<div class="sourceCode" id="cb1136"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span>  <span class="co">## obtenir un cadre de données ordonné des résultats</span></span>
<span>  <span class="co">#broom::tidy(exponentiate = TRUE, </span></span>
<span>  <span class="co">#     conf.int = TRUE)</span></span></code></pre></div>
<p>Une rapide inspection visuelle du modèle montre qu’il pourrait faire un meilleur travail pour d’estimer le nombre de cas observés.</p>
<div class="sourceCode" id="cb1137"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">estimate_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span>
<span>     </span>
<span><span class="co">## Tracez votre régression </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">estimate_res</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajouter une ligne pour l'estimation du modèle</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,</span>
<span>            col <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajouter une bande pour les intervalles de prédiction </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, </span>
<span>                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajouter une ligne pour le nombre de cas observés</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, </span>
<span>            col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## faire un graphique traditionnel (avec des axes noirs et un fond blanc)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/plot_nb_reg_bivar-1.png" width="672"></div>
<div id="résidus-1" class="section level4 unnumbered">
<h4>Résidus<a class="anchor" aria-label="anchor" href="#r%C3%A9sidus-1"><i class="fas fa-link"></i></a>
</h4>
<p>Nous examinons à nouveau les résidus pour voir si notre modèle s’adapte bien aux données observées. Les résultats et l’interprétation sont ici similaires à ceux de la régression précédente, donc il est peut-être plus judicieux de s’en tenir au modèle plus simple sans température.</p>
<div class="sourceCode" id="cb1138"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## calculer les résidus </span></span>
<span><span class="va">estimate_res</span> <span class="op">&lt;-</span> <span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span>resid <span class="op">=</span> <span class="va">case_int</span> <span class="op">-</span> <span class="va">estimate</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## les résidus sont-ils assez constants dans le temps (si non : épidémies ? changement de pratique ?)</span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"epiweek"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-848-1.png" width="672"></div>
<div class="sourceCode" id="cb1139"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Y a-t-il une autocorrélation dans les résidus (y a-t-il un modèle d'erreur ?) ?  </span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">ACF</span><span class="op">(</span><span class="va">resid</span>, lag_max <span class="op">=</span> <span class="fl">52</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/autoplot.html">autoplot</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-848-2.png" width="672"></div>
<div class="sourceCode" id="cb1140"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## les résidus sont-ils normalement distribués (y a-t-il sous-estimation ou surestimation ?)  </span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_histogram.html">geom_histogram</a></span><span class="op">(</span>binwidth <span class="op">=</span> <span class="fl">100</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_rug.html">geom_rug</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>y <span class="op">=</span> <span class="st">"count"</span><span class="op">)</span> </span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-848-3.png" width="672"></div>
<div class="sourceCode" id="cb1141"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## comparer les comptages observés à leurs résidus </span></span>
<span>  <span class="co">## il ne devrait pas y avoir de modèle </span></span>
<span><span class="va">estimate_res</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">estimate</span>, y <span class="op">=</span> <span class="va">resid</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span><span class="op">(</span>x <span class="op">=</span> <span class="st">"Fitted"</span>, y <span class="op">=</span> <span class="st">"Residuals"</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/unnamed-chunk-848-4.png" width="672"></div>
<div class="sourceCode" id="cb1142"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## tester formellement l'autocorrélation des résidus</span></span>
<span><span class="co">## H0 est que les résidus proviennent d'une série à bruit blanc (c'est-à-dire aléatoire)</span></span>
<span><span class="co">## Test d'indépendance </span></span>
<span><span class="co">### si la valeur p est significative alors non aléatoire</span></span>
<span><span class="fu"><a href="https://rdrr.io/r/stats/box.test.html">Box.test</a></span><span class="op">(</span><span class="va">estimate_res</span><span class="op">$</span><span class="va">resid</span>, type <span class="op">=</span> <span class="st">"Ljung-Box"</span><span class="op">)</span></span></code></pre></div>
<pre><code>## 
##  Box-Ljung test
## 
## data:  estimate_res$resid
## X-squared = 339.52, df = 1, p-value &lt; 2.2e-16</code></pre>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="détection-des-épidémies" class="section level2" number="23.7">
<h2>
<span class="header-section-number">23.7</span> Détection des épidémies<a class="anchor" aria-label="anchor" href="#d%C3%A9tection-des-%C3%A9pid%C3%A9mies"><i class="fas fa-link"></i></a>
</h2>
<p>Nous allons démontrer ici deux méthodes (similaires) de détection des épidémies.
La première s’appuie sur les sections précédentes. Nous utilisons le paquet <strong>trending</strong> pour ajuster les régressions aux années précédentes, et puisprédire ce que nous nous attendons à voir l’année suivante. Si les comptages observés sont supérieursce que nous attendons, cela pourrait suggérer qu’il y a une épidémie. La deuxième méthode est basée sur des principes similaires mais utilise le paquet <strong>surveillance</strong>,qui possède un certain nombre d’algorithmes différents pour la détection des aberrations.</p>
<p><span style="color : orange ;"><strong><em>ATTENTION:</em></strong> Normalement, vous vous intéressez à l’année en cours (où vous ne connaissez que les comptages jusqu’à la semaine actuelle). Donc, dans cet exemple, nous prétendons être dans la semaine 39 de 2011.</span></p>
<!-- ======================================================= -->
<div id="tendance-paquet" class="section level3 unnumbered">
<h3>
<strong>tendance</strong> paquet<a class="anchor" aria-label="anchor" href="#tendance-paquet"><i class="fas fa-link"></i></a>
</h3>
<p>Pour cette méthode, nous définissons une ligne de base (qui devrait généralement être d’environ 5 ans de données). Nous ajustons une régression aux données de base, puis nous l’utilisons pour prédire les estimations pour l’année suivante.</p>
<!-- ======================================================= -->
<div id="date-limite" class="section level4 unnumbered">
<h4>Date limite<a class="anchor" aria-label="anchor" href="#date-limite"><i class="fas fa-link"></i></a>
</h4>
<p>Il est plus facile de définir vos dates à un endroit, puis de les utiliser dans le reste de votre code.</p>
<p>Ici nous définissons une date de début (quand nos observations ont commencé) et une date limite (la fin de notre période de référence - et le début de la période pour laquelle nous voulons prédire).Nous définissons également le nombre de semaines entre la date limite de la période de référence et la date de fin de la période pour laquelle nous sommes intéressés à prédire.</p>
<p><span style="color : black ;"><strong><em>ATTENTION:</em></strong> Dans cet exemple, nous prétendons être actuellement à la fin du mois de septembre 2011 (“2011 W39”).</span></p>
<div class="sourceCode" id="cb1144"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## définir la date de début (quand les observations ont commencé)</span></span>
<span><span class="va">start_date</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## définir une semaine de coupure (fin de la ligne de base, début de la période de prédiction)</span></span>
<span><span class="va">cut_off</span> <span class="op">&lt;-</span> <span class="fu">yearweek</span><span class="op">(</span><span class="st">"2010-12-31"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## définir la dernière date qui nous intéresse (c'est-à-dire la fin de la prédiction)</span></span>
<span><span class="va">end_date</span> <span class="op">&lt;-</span> <span class="fu">yearweek</span><span class="op">(</span><span class="st">"2011-12-31"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## trouver combien de semaines dans la période (année) d'intérêt.</span></span>
<span><span class="va">num_weeks</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">end_date</span> <span class="op">-</span> <span class="va">cut_off</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="ajoutez-des-lignes-.unnumbered." class="section level4" number="23.7.0.1">
<h4>
<span class="header-section-number">23.7.0.1</span> Ajoutez des lignes {.unnumbered}.<a class="anchor" aria-label="anchor" href="#ajoutez-des-lignes-.unnumbered."><i class="fas fa-link"></i></a>
</h4>
<p>Pour pouvoir faire des prévisions dans un format tidyverse, nous devons avoir le bon nombre de lignes dans notre jeu de données, c’est-à-dire une ligne pour chaque semaine jusqu’à la date de fin définie ci-dessus. Le code ci-dessous vous permet d’ajouter ces lignes par une variable de regroupement - par exemple, si nous avons plusieurs pays dans un même ensemble de données, nous pouvons ajouter des lignes pour chacun d’entre eux. La fonction <code>group_by_key()</code> de <strong>tsibble</strong> nous permet d’effectuer ce regroupement, et ensuite de passer les données groupées aux fonctions <strong>dplyr</strong>, <code><a href="https://dplyr.tidyverse.org/reference/group_map.html">group_modify()</a></code> et <code><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row()</a></code>. Ensuite, nous spécifions la séquence des semaines entre une après la semaine maximale actuellement disponible dans les données et la semaine de fin.</p>
<div class="sourceCode" id="cb1145"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## ajouter les semaines manquantes jusqu'à la fin de l'année </span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## regrouper par région</span></span>
<span>  <span class="fu">group_by_key</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="co">## pour chaque groupe, ajoutez les lignes à partir de la semaine d'épi la plus élevée jusqu'à la fin de l'année</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_map.html">group_modify</a></span><span class="op">(</span><span class="op">~</span><span class="fu"><a href="https://tibble.tidyverse.org/reference/add_row.html">add_row</a></span><span class="op">(</span><span class="va">.</span>,</span>
<span>                        epiweek <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">.</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>, </span>
<span>                                      <span class="va">end_date</span>,</span>
<span>                                      by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="termes-de-fourier-1" class="section level4 unnumbered">
<h4>Termes de Fourier<a class="anchor" aria-label="anchor" href="#termes-de-fourier-1"><i class="fas fa-link"></i></a>
</h4>
<p>Nous devons redéfinir nos termes de Fourier, car nous voulons les adapter à la date de base uniquement, puis prédire (extrapoler) ces termes pour l’annee suivante. Pour ce faire, nous devons combiner deux listes de sortie de la fonction <code>fourier()</code> ensemble ; la première est pour les données de base, et la seconde prédit pour l’année qui nous intéresse (en définissant le paramètre <code>fourier()</code>).</p>
<p><em>N.b.</em> pour lier les lignes, nous devons utiliser <code><a href="https://rdrr.io/r/base/cbind.html">rbind()</a></code> (plutôt que tidyverse <code>bind_rows</code>) carles colonnes de fourier sont une liste (et ne sont donc pas nommées individuellement).</p>
<div class="sourceCode" id="cb1146"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## définir les termes de fourier (sincos) </span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## combiner les termes de fourier pour les semaines avant et après la date limite de 2010</span></span>
<span>    <span class="co">## (nb. les termes de fourier de 2011 sont prédits)</span></span>
<span>    fourier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>      <span class="co">## obtenir les termes de fourier pour les années précédentes</span></span>
<span>      <span class="fu">fourier</span><span class="op">(</span></span>
<span>        <span class="co">## garder uniquement les lignes avant 2011</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">counts</span>, </span>
<span>               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cut_off</span><span class="op">)</span>, </span>
<span>        <span class="co">## inclure un ensemble de termes sin cos </span></span>
<span>        K <span class="op">=</span> <span class="fl">1</span></span>
<span>        <span class="op">)</span>, </span>
<span>      <span class="co">## prédire les termes de fourier pour 2011 (en utilisant les données de base)</span></span>
<span>      <span class="fu">fourier</span><span class="op">(</span></span>
<span>        <span class="co">## garder uniquement les lignes avant 2011</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">counts</span>, </span>
<span>               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cut_off</span><span class="op">)</span>,</span>
<span>        <span class="co">## inclure un ensemble de termes sin cos </span></span>
<span>        K <span class="op">=</span> <span class="fl">1</span>, </span>
<span>        <span class="co">## prédire 52 semaines à l'avance</span></span>
<span>        h <span class="op">=</span> <span class="va">num_weeks</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span></code></pre></div>
<!-- ======================================================= -->
</div>
<div id="diviser-les-données-et-ajuster-la-régression" class="section level4 unnumbered">
<h4>Diviser les données et ajuster la régression<a class="anchor" aria-label="anchor" href="#diviser-les-donn%C3%A9es-et-ajuster-la-r%C3%A9gression"><i class="fas fa-link"></i></a>
</h4>
<p>Nous devons maintenant diviser notre ensemble de données en deux périodes : la période de base et la période de prédiction. Ceci est fait en utilisant la fonction <strong>dplyr</strong> <code><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split()</a></code> après <code><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by()</a></code>, et créera une liste avec deux cadres de données, un pour la période avant la coupure et un pour la période après la coupure.</p>
<p>Nous utilisons ensuite la fonction <code><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck()</a></code> du paquet <strong>purrr</strong> pour extraire les ensembles de données de la liste (ce qui équivaut à utiliser des crochets, par exemple <code>dat[[1]]</code>), et nous pouvons alors ajuster notre modèle aux données de base, et ensuite utiliser la fonction <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code> pour nos données d’intérêt après la coupure.</p>
<p>Consultez la page sur <a href="iteration.html#iteration">l’itération, les boucles et les listes</a> pour en savoir plus sur <strong>purrr</strong>.</p>
<p><span style="color : orange ;"><strong><em>ATTENTION:</em></strong> Notez l’utilisation de <code>simulate_pi = FALSE</code> dans l’argument <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>. Ceci est dû au fait que le comportement par défaut de <strong>trending</strong> est d’utiliser le paquet <strong>ciTools</strong> pour estimer un intervalle de prédiction. Cela ne fonctionne pas s’il y a des comptes <code>NA</code>, et produit également des intervalles plus granulaires. Voir <code>?trending::predict.trending_model_fit</code> pour plus de détails. </span></p>
<div class="sourceCode" id="cb1147"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># diviser les données pour l'ajustement et la prédiction</span></span>
<span><span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cut_off</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## définir le modèle que vous voulez ajuster (binomial négatif) </span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>  <span class="co">## définir le nombre de cas comme résultat d'intérêt</span></span>
<span>  <span class="va">case_int</span> <span class="op">~</span></span>
<span>    <span class="co">## utiliser epiweek pour tenir compte de la tendance</span></span>
<span>    <span class="va">epiweek</span> <span class="op">+</span></span>
<span>    <span class="co">## utiliser les termes de fourier pour tenir compte de la saisonnalité</span></span>
<span>    <span class="va">fourier</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="co"># définir les données à utiliser pour l'ajustement et celles pour la prédiction.</span></span>
<span><span class="va">fitting_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">2</span><span class="op">)</span></span>
<span><span class="va">pred_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">case_int</span>, <span class="va">epiweek</span>, <span class="va">fourier</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># ajustement du modèle </span></span>
<span><span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">fitting_data</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># obtenir le confint et les estimations pour les données ajustées</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span>simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># prévoir avec les données que l'on veut prévoir avec </span></span>
<span><span class="va">forecast</span> <span class="op">&lt;-</span> <span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">pred_data</span><span class="op">)</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## combiner les ensembles de données de base et prédits</span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">result</span>, <span class="va">forecast</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span></code></pre></div>
<p>Comme précédemment, nous pouvons visualiser notre modèle avec <strong>ggplot</strong>. Nous mettons en évidence les alertes avecpoints rouges pour les comptes observés au-dessus de l’intervalle de prédiction de 95 %. Cette fois, nous ajoutons également une ligne verticale pour indiquer quand la prévision commence.</p>
<div class="sourceCode" id="cb1148"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Tracez votre régression </span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">observed</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajoutez une ligne pour l'estimation du modèle</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span><span class="op">)</span>,</span>
<span>            col <span class="op">=</span> <span class="st">"grey"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajouter une bande pour les intervalles de prédiction </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, </span>
<span>                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajouter une ligne pour le nombre de cas observés</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, </span>
<span>            col <span class="op">=</span> <span class="st">"black"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## Tracez des points pour les nombres observés supérieurs aux prévisions.</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_point.html">geom_point</a></span><span class="op">(</span></span>
<span>    data <span class="op">=</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">observed</span>, <span class="va">case_int</span> <span class="op">&gt;</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>    <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span><span class="op">)</span>, </span>
<span>    color <span class="op">=</span> <span class="st">"red"</span>, </span>
<span>    size <span class="op">=</span> <span class="fl">2</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajouter une ligne verticale et une étiquette pour montrer où la prévision a commencé</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span></span>
<span>           xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">cut_off</span><span class="op">)</span>, </span>
<span>           linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"text"</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Forecast"</span>, </span>
<span>           x <span class="op">=</span> <span class="va">cut_off</span>, </span>
<span>           y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">upper_pi</span><span class="op">)</span> <span class="op">-</span> <span class="fl">250</span>, </span>
<span>           angle <span class="op">=</span> <span class="fl">90</span>, </span>
<span>           vjust <span class="op">=</span> <span class="fl">1</span></span>
<span>           <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## faire un graphique traditionnel (avec des axes noirs et un fond blanc)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<pre><code>## Warning: Removed 13 rows containing missing values (`geom_line()`).</code></pre>
<div class="inline-figure"><img src="_main_files/figure-html/forecast_plot-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="validation-de-la-prédiction" class="section level4 unnumbered">
<h4>Validation de la prédiction<a class="anchor" aria-label="anchor" href="#validation-de-la-pr%C3%A9diction"><i class="fas fa-link"></i></a>
</h4>
<p>Au-delà de l’inspection des résidus, il est important d’étudier la capacité de votre modèle à prédire les cas dans le futur. Cela vous donne une idée de la fiabilité de vos
seuils d’alerte.</p>
<p>La méthode traditionnelle de validation consiste à voir dans quelle mesure vous pouvez prédire l’année la plus récente avant l’année en cours (parce que vous ne pouvez pas prédire l’année en cours).Par exemple, dans notre ensemble de données, nous utiliserions les données de 2002 à 2009 pour prédire 2010, et ensuite voir si ces prédictions sont exactes. Ensuite, nous réajustons le modèle pour incluredonnées de 2010 et les utiliser pour prédire les comptages de 2011.</p>
<p>Comme on peut le voir dans la figure ci-dessous, réalisée par <em>Hyndman et al</em> dans <a href="https://otexts.com/fpp3/">“Forecasting principles and practice”</a>.</p>
<p><img src="https://otexts.com/fpp3/fpp_files/figure-html/traintest-1.png"><em>figure reproduite avec l’autorisation des auteurs</em>.</p>
<p>L’inconvénient de cette méthode est que vous n’utilisez pas toutes les données dont vous disposez et que vous n’obtenez pas le modèle final que vous utilisez pour la prédiction.</p>
<p>Une alternative consiste à utiliser une méthode appelée validation croisée. Dans ce scénario, vous passez en revue toutes les données disponibles pour ajuster plusieurs modèles afin de prédire un an à l’avance. Vous utilisez de plus en plus de données dans chaque modèle, comme le montre la figure ci-dessous tirée de la même [<em>Hyndman et al</em> texte]((<a href="https://otexts.com/fpp3/" class="uri">https://otexts.com/fpp3/</a>). Par exemple, le premier modèle utilise 2002 pour prédire 2003, le second utilise 2002 et 2003 pour prédire 2004, et ainsi de suite.
<img src="https://otexts.com/fpp2/fpp_files/figure-html/cv1-1.png"><em>figure reproduite avec l’autorisation des auteurs</em>.</p>
<p>Dans la figure ci-dessous, nous utilisons la fonction <code><a href="https://purrr.tidyverse.org/reference/map.html">map()</a></code> du paquet <strong>purrr</strong> pour boucler sur chaque ensemble de données. Nous mettons ensuite les estimations dans un seul ensemble de données et les fusionnons avec le nombre de cas original, pour utiliser le paquet <strong>yardstick</strong> pour calculer les mesures de précision. Nous calculons quatre mesures, notamment Erreur quadratique moyenne (RMSE), Erreur absolue moyenne (MAE) l’erreur absolue moyenne mise à l’échelle (MASE), l’erreur absolue moyenne en pourcentage (MAPE).</p>
<p><span style="color : orange ;"><strong><em>CAUTION:</em></strong> Notez l’utilisation de <code>simulate_pi = FALSE</code> dans l’argument <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>. Ceci est dû au fait que le comportement par défaut de <strong>trending</strong> est d’utiliser le paquet <strong>ciTools</strong> pour estimer un intervalle de prédiction. Cela ne fonctionne pas s’il y a des comptes <code>NA</code>, et produit également des intervalles plus granulaires. Voir <code>?trending::predict.trending_model_fit</code> pour plus de détails. </span></p>
<div class="sourceCode" id="cb1150"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Validation croisée : prédire la ou les semaines à venir en fonction de la fenêtre glissante.</span></span>
<span></span>
<span><span class="co">## élargissez vos données en les faisant glisser dans des fenêtres de 52 semaines (avant + après). </span></span>
<span><span class="co">## pour prédire les 52 semaines à venir</span></span>
<span><span class="co">## (crée des chaînes d'observations de plus en plus longues - conserve les données plus anciennes)</span></span>
<span></span>
<span><span class="co">## définir la fenêtre que l'on veut faire glisser</span></span>
<span><span class="va">roll_window</span> <span class="op">&lt;-</span> <span class="fl">52</span></span>
<span></span>
<span><span class="co">## Définir les semaines à venir à prévoir </span></span>
<span><span class="va">weeks_ahead</span> <span class="op">&lt;-</span> <span class="fl">52</span></span>
<span></span>
<span><span class="co">## créer un ensemble de données répétitives, de plus en plus longues.</span></span>
<span><span class="co">## étiqueter chaque ensemble de données avec un identifiant unique.</span></span>
<span><span class="co">## utiliser seulement les cas avant l'année d'intérêt (i.e. 2011)</span></span>
<span><span class="va">case_roll</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&lt;</span> <span class="va">cut_off</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## Garder uniquement les variables de la semaine et du nombre de cas.</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## laisser tomber les x dernières observations </span></span>
<span>    <span class="co">## en fonction du nombre de semaines d'anticipation de la prévision. </span></span>
<span>    <span class="co">## (sinon ce sera une prévision réelle à "inconnu")</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/slice.html">slice</a></span><span class="op">(</span><span class="fl">1</span> <span class="op">:</span><span class="op">(</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/context.html">n</a></span><span class="op">(</span><span class="op">)</span> <span class="op">-</span> <span class="va">weeks_ahead</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## reconduire chaque semaine dans x après les fenêtres pour créer l'ID de regroupement </span></span>
<span>    <span class="co">## en fonction de la fenêtre de roulement spécifiée</span></span>
<span>    <span class="fu">stretch_tsibble</span><span class="op">(</span>.init <span class="op">=</span> <span class="va">roll_window</span>, .step <span class="op">=</span> <span class="fl">1</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## laisser tomber les deux premiers - car il n'y a pas de cas "avant".</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">.id</span> <span class="op">&gt;</span> <span class="va">roll_window</span><span class="op">)</span></span>
<span></span>
<span></span>
<span><span class="co">## pour chacun des ensembles de données uniques, exécutez le code ci-dessous</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu">purrr</span><span class="fu">::</span><span class="fu"><a href="https://purrr.tidyverse.org/reference/map.html">map</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/unique.html">unique</a></span><span class="op">(</span><span class="va">case_roll</span><span class="op">$</span><span class="va">.id</span><span class="op">)</span>, </span>
<span>                        <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="op">{</span></span>
<span>  </span>
<span>  <span class="co">## garder uniquement le pli courant en cours d'ajustement </span></span>
<span>  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">case_roll</span>, <span class="va">.id</span> <span class="op">==</span> <span class="va">i</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://tibble.tidyverse.org/reference/as_tibble.html">as_tibble</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## créer un ensemble de données vides pour la prévision sur </span></span>
<span>  <span class="va">forecast_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://tibble.tidyverse.org/reference/tibble.html">tibble</a></span><span class="op">(</span></span>
<span>    epiweek <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/seq.html">seq</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mini_data</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span> <span class="op">+</span> <span class="fl">1</span>,</span>
<span>                  <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">mini_data</span><span class="op">$</span><span class="va">epiweek</span><span class="op">)</span> <span class="op">+</span> <span class="va">weeks_ahead</span>,</span>
<span>                  by <span class="op">=</span> <span class="fl">1</span><span class="op">)</span>,</span>
<span>    case_int <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep.int</a></span><span class="op">(</span><span class="cn">NA</span>, <span class="va">weeks_ahead</span><span class="op">)</span>,</span>
<span>    .id <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html">rep.int</a></span><span class="op">(</span><span class="va">i</span>, <span class="va">weeks_ahead</span><span class="op">)</span></span>
<span>  <span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## ajouter les données de prévision à l'original </span></span>
<span>  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">mini_data</span>, <span class="va">forecast_data</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## définir le cut off basé sur les dernières données de comptage non manquantes. </span></span>
<span>  <span class="va">cv_cut_off</span> <span class="op">&lt;-</span> <span class="va">mini_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## ne garder que les lignes non manquantes</span></span>
<span>    <span class="fu"><a href="https://tidyr.tidyverse.org/reference/drop_na.html">drop_na</a></span><span class="op">(</span><span class="va">case_int</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## obtenir la dernière semaine</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/summarise.html">summarise</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="co">## extraire ce qui n'est pas dans un dataframe</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/pull.html">pull</a></span><span class="op">(</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## Remettre mini_data dans un tsibble</span></span>
<span>  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="fu">tsibble</span><span class="op">(</span><span class="va">mini_data</span>, index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co">## définir les termes de fourier (sincos) </span></span>
<span>  <span class="va">mini_data</span> <span class="op">&lt;-</span> <span class="va">mini_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## Combinez les termes de Fourier pour les semaines avant et après la date limite.</span></span>
<span>    fourier <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/cbind.html">rbind</a></span><span class="op">(</span></span>
<span>      <span class="co">## obtenir les termes de fourier pour les années précédentes</span></span>
<span>      <span class="fu">forecast</span><span class="fu">::</span><span class="fu"><a href="https://pkg.robjhyndman.com/forecast/reference/fourier.html">fourier</a></span><span class="op">(</span></span>
<span>        <span class="co">### ne conserve que les lignes avant la date butoir</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">mini_data</span>, </span>
<span>               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cv_cut_off</span><span class="op">)</span>, </span>
<span>        <span class="co">## inclure un ensemble de termes sin cos </span></span>
<span>        K <span class="op">=</span> <span class="fl">1</span></span>
<span>        <span class="op">)</span>, </span>
<span>      <span class="co">## prédire les termes de fourier pour l'année suivante (en utilisant les données de base)</span></span>
<span>      <span class="fu">fourier</span><span class="op">(</span></span>
<span>        <span class="co">## conserver uniquement les lignes avant la coupure</span></span>
<span>        <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">mini_data</span>, </span>
<span>               <span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cv_cut_off</span><span class="op">)</span>,</span>
<span>        <span class="co">## inclure un ensemble de termes sin cos </span></span>
<span>        K <span class="op">=</span> <span class="fl">1</span>, </span>
<span>        <span class="co">## prédire 52 semaines à l'avance</span></span>
<span>        h <span class="op">=</span> <span class="va">weeks_ahead</span></span>
<span>        <span class="op">)</span></span>
<span>      <span class="op">)</span></span>
<span>    <span class="op">)</span></span>
<span>  </span>
<span>  </span>
<span>  <span class="co"># diviser les données pour l'ajustement et la prédiction</span></span>
<span>  <span class="va">dat</span> <span class="op">&lt;-</span> <span class="va">mini_data</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_by.html">group_by</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&lt;=</span> <span class="va">cv_cut_off</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/group_split.html">group_split</a></span><span class="op">(</span><span class="op">)</span></span>
<span></span>
<span>  <span class="co">## définir le modèle que vous voulez ajuster (binomiale négative) </span></span>
<span>  <span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>    <span class="co">## définir le nombre de cas comme résultat d'intérêt</span></span>
<span>    <span class="va">case_int</span> <span class="op">~</span></span>
<span>      <span class="co">## utiliser epiweek pour tenir compte de la tendance</span></span>
<span>      <span class="va">epiweek</span> <span class="op">+</span></span>
<span>      <span class="co">## utiliser les termes de fourier pour tenir compte de la saisonnalité</span></span>
<span>      <span class="va">fourier</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span>  <span class="co"># définir les données à utiliser pour l'ajustement et celles pour la prédiction.</span></span>
<span>  <span class="va">fitting_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">2</span><span class="op">)</span></span>
<span>  <span class="va">pred_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://purrr.tidyverse.org/reference/pluck.html">pluck</a></span><span class="op">(</span><span class="va">dat</span>, <span class="fl">1</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># ajuster le modèle </span></span>
<span>  <span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">fitting_data</span><span class="op">)</span><span class="op">)</span></span>
<span>  </span>
<span>  <span class="co"># prévoir avec les données que l'on veut prédire avec </span></span>
<span>  <span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>    <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">pred_data</span><span class="op">)</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span> </span>
<span> <span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">forecasts</span><span class="op">$</span><span class="va">result</span><span class="op">[[</span><span class="fl">1</span><span class="op">]</span><span class="op">]</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>      <span class="co">## garder seulement la semaine et l'estimation de la prévision</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">epiweek</span>, <span class="va">estimate</span><span class="op">)</span></span>
<span>    </span>
<span>  <span class="op">}</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## Transformer la liste en un cadre de données avec toutes les prévisions.</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span><span class="va">forecasts</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## joindre les prévisions aux données observées</span></span>
<span><span class="va">forecasts</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate-joins.html">left_join</a></span><span class="op">(</span><span class="va">forecasts</span>, </span>
<span>                       <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">counts</span>, <span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span>,</span>
<span>                       by <span class="op">=</span> <span class="st">"epiweek"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## en utilisant {yardstick} calculer les métriques</span></span>
<span>  <span class="co">## RMSE : Root mean squared error (erreur quadratique moyenne)</span></span>
<span>  <span class="co">## MAE : Erreur absolue moyenne   </span></span>
<span>  <span class="co">## MASE : Mean absolute scaled error (erreur absolue moyenne mise à l'échelle)</span></span>
<span>  <span class="co">## MAPE : Erreur absolue moyenne en pourcentage</span></span>
<span><span class="va">model_metrics</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/bind_rows.html">bind_rows</a></span><span class="op">(</span></span>
<span>  <span class="co">## dans votre ensemble de données forcées, comparez les données observées aux données prédites.</span></span>
<span>  <span class="fu">rmse</span><span class="op">(</span><span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>, </span>
<span>  <span class="fu">mae</span><span class="op">(</span> <span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>,</span>
<span>  <span class="fu">mase</span><span class="op">(</span><span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>,</span>
<span>  <span class="fu">mape</span><span class="op">(</span><span class="va">forecasts</span>, <span class="va">case_int</span>, <span class="va">estimate</span><span class="op">)</span>,</span>
<span>  <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">### ne conserve que le type de métrique et sa sortie</span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span>Metric <span class="op">=</span> <span class="va">.metric</span>, </span>
<span>         Measure <span class="op">=</span> <span class="va">.estimate</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## faire en sorte que le format soit large pour pouvoir lier les lignes ensuite</span></span>
<span>  <span class="fu"><a href="https://tidyr.tidyverse.org/reference/pivot_wider.html">pivot_wider</a></span><span class="op">(</span>names_from <span class="op">=</span> <span class="va">Metric</span>, values_from <span class="op">=</span> <span class="va">Measure</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## Retourner les métriques du modèle </span></span>
<span><span class="va">model_metrics</span></span></code></pre></div>
<pre><code>## # A tibble: 1 × 4
##    rmse   mae  mase  mape
##   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;
## 1  252.  199.  1.96  17.3</code></pre>
<!-- ======================================================= -->
</div>
</div>
<div id="surveillance-paquet" class="section level3 unnumbered">
<h3>
<strong>surveillance</strong> paquet<a class="anchor" aria-label="anchor" href="#surveillance-paquet"><i class="fas fa-link"></i></a>
</h3>
<p>Dans cette section, nous utilisons le paquet <strong>surveillance</strong> pour créer des seuils d’alerte basés sur des algorithmes de détection d’épidémies. Il existe plusieurs méthodes différentes disponibles dans le paquet, mais nous nous concentrerons ici sur deux options. Pour plus de détails, voir ces articles sur <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/monitoringCounts.pdf">l’application</a> et <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/glrnb.pdf">théorie</a>
des alogirths utilisés.</p>
<p>La première option utilise la méthode améliorée de Farrington. Celle-ci ajuste un glm binomial négatif (y compris la tendance) et pondère à la baisse les épidémies passées (valeurs aberrantes) pour créer un niveau de seuil.</p>
<p>La deuxième option utilise la méthode glrnb. Celle-ci ajuste également un glm binomial négatif
binomiale négative, mais inclut la tendance et les termes de Fourier (elle est donc privilégiée ici). La régression est utilisée pour calculer la “moyenne de contrôle” (~valeurs ajustées) - elle utilise ensuite une statistique de rapport de vrai semblance généralisé calculé pour évaluer s’il y a un changement de la moyenne pour chaque semaine. Notez que le seuil pour chaque semaine prend en compte les semaines précédentes, de sorte que s’il y a un changement soutenu, une alarme sera déclenchée. (Notez également qu’après chaque alarme, l’algorithme est réinitialisé).</p>
<p>Afin de travailler avec le paquet <strong>surveillance</strong>, nous devons d’abord définir un objet “série temporelle de surveillance” (en utilisant la fonction <code>sts()</code>) pour s’intégrer dans le cadre.</p>
<div class="sourceCode" id="cb1152"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Définir un objet de série temporelle de surveillance</span></span>
<span><span class="co">## nb. vous pouvez inclure un dénominateur avec l'objet population (voir ?sts)</span></span>
<span><span class="va">counts_sts</span> <span class="op">&lt;-</span> <span class="fu">sts</span><span class="op">(</span>observed <span class="op">=</span> <span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">[</span><span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span><span class="op">]</span>,</span>
<span>                  start <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span></span>
<span>                    <span class="co">## sous-ensemble pour ne garder que l'année de start_date. </span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="fl">1</span>, <span class="fl">4</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                    <span class="co">## sous-ensemble pour ne conserver que la semaine à partir de la date de départ</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://stringr.tidyverse.org/reference/str_sub.html">str_sub</a></span><span class="op">(</span><span class="va">start_date</span>, <span class="fl">7</span>, <span class="fl">8</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>, </span>
<span>                  <span class="co">## définir le type de données (dans ce cas, hebdomadaire)</span></span>
<span>                  freq <span class="op">=</span> <span class="fl">52</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## définir la plage de semaines que vous voulez inclure (c'est-à-dire la période de prédiction)</span></span>
<span><span class="co">## nb. l'objet sts ne compte que les observations sans leur attribuer un identifiant de semaine ou d'année. </span></span>
<span><span class="co">## d'année - nous utilisons donc nos données pour définir les observations appropriées.</span></span>
<span><span class="va">weekrange</span> <span class="op">&lt;-</span> <span class="va">cut_off</span> <span class="op">-</span> <span class="va">start_date</span></span></code></pre></div>
<!-- ======================================================= -->
<div id="méthode-farrington" class="section level4 unnumbered">
<h4>Méthode Farrington<a class="anchor" aria-label="anchor" href="#m%C3%A9thode-farrington"><i class="fas fa-link"></i></a>
</h4>
<p>Nous définissons ensuite chacun de nos paramètres pour la méthode de Farrington dans une <code>liste</code>.
Ensuite, nous exécutons l’algorithme en utilisant <code>farringtonFlexible()</code> et ensuite nous pouvons extraire le seuil d’une alerte en utilisant <code>farringtonmethod@upperbound</code> pour l’inclure dans notre données. Il est également possible d’extraire un VRAI/FAUX pour chaque semaine si elle a déclenché une alerte (au-dessus du seuil) en utilisant <code>farringtonmethod@alarm</code>.</p>
<div class="sourceCode" id="cb1153"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## définir le contrôle</span></span>
<span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="co">## définissez la période pour laquelle vous voulez un seuil (i.e. 2011)</span></span>
<span>  range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts_sts</span><span class="op">@</span><span class="va">epoch</span> <span class="op">&gt;</span> <span class="va">weekrange</span><span class="op">)</span>,</span>
<span>  b <span class="op">=</span> <span class="fl">9</span>, <span class="co">## nombre d'années en arrière pour la ligne de base</span></span>
<span>  w <span class="op">=</span> <span class="fl">2</span>, <span class="co">## taille de la fenêtre de roulement en semaines</span></span>
<span>  weightsThreshold <span class="op">=</span> <span class="fl">2.58</span>, <span class="co">## repondération des épidémies passées (méthode noufaily améliorée - l'originale suggère 1)</span></span>
<span>  <span class="co">## pastWeeksNotIncluded = 3, ## utilisation de toutes les semaines disponibles (noufaily suggère d'en éliminer 26)</span></span>
<span>  trend <span class="op">=</span> <span class="cn">TRUE</span>,</span>
<span>  pThresholdTrend <span class="op">=</span> <span class="fl">1</span>, <span class="co">## 0.05 normalement, mais 1 est conseillé dans la méthode améliorée (c'est-à-dire toujours garder)</span></span>
<span>  thresholdMethod <span class="op">=</span> <span class="st">"nbPlugin"</span>,</span>
<span>  populationOffset <span class="op">=</span> <span class="cn">TRUE</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## appliquer la méthode flexible de Farrington</span></span>
<span><span class="va">farringtonmethod</span> <span class="op">&lt;-</span> <span class="fu">farringtonFlexible</span><span class="op">(</span><span class="va">counts_sts</span>, <span class="va">ctrl</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## créer une nouvelle variable dans le jeu de données original appelée threshold.</span></span>
<span><span class="co">## contenant la limite supérieure de Farrington. </span></span>
<span><span class="co">## nb. ceci est seulement pour les semaines de 2011 (donc besoin de sous-ensembler les lignes)</span></span>
<span><span class="va">counts</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">epiweek</span> <span class="op">&gt;=</span> <span class="va">cut_off</span> <span class="op">&amp;</span> </span>
<span>               <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              <span class="st">"threshold"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">farringtonmethod</span><span class="op">@</span><span class="va">upperbound</span></span></code></pre></div>
<p>Nous pouvons ensuite visualiser les résultats dans ggplot comme nous l’avons fait précédemment.</p>
<div class="sourceCode" id="cb1154"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajouter le nombre de cas observés sous forme de ligne</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span>, colour <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajout de la limite supérieure de l'algorithme d'aberration</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">threshold</span>, colour <span class="op">=</span> <span class="st">"Alert threshold"</span><span class="op">)</span>, </span>
<span>            linetype <span class="op">=</span> <span class="st">"dashed"</span>, </span>
<span>            size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## définir les couleurs</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                                 <span class="st">"Alert threshold"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## faire un graphique traditionnel (avec des axes noirs et un fond blanc)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## supprimer le titre de la légende </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/plot_farrington-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="méthode-glrnb" class="section level4 unnumbered">
<h4>Méthode GLRNB<a class="anchor" aria-label="anchor" href="#m%C3%A9thode-glrnb"><i class="fas fa-link"></i></a>
</h4>
<p>De même pour la méthode GLRNB, nous définissons chacun de nos paramètres pour le dans une <code>liste</code>, puis nous ajustons l’algorithme et extrayons les limites supérieures.</p>
<p><span style="color : orange ;"><strong><em>ATTENTION:</em></strong> Cette méthode utilise la “force brute” (similaire au bootstrapping) pour calculer les seuils, donc peut prendre beaucoup de temps!</span>.</p>
<p>Voir la <a href="https://cran.r-project.org/web/packages/surveillance/vignettes/glrnb.pdf">vignette GLRNB</a> pour plus de détails.</p>
<div class="sourceCode" id="cb1155"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## définir les options de contrôle</span></span>
<span><span class="va">ctrl</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span></span>
<span>  <span class="co">## définir la période pour laquelle on veut un seuil (i.e. 2011)</span></span>
<span>  range <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts_sts</span><span class="op">@</span><span class="va">epoch</span> <span class="op">&gt;</span> <span class="va">weekrange</span><span class="op">)</span>,</span>
<span>  mu0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span><span class="op">(</span>S <span class="op">=</span> <span class="fl">1</span>, <span class="co">## nombre de termes de fourier (harmoniques) à inclure</span></span>
<span>  trend <span class="op">=</span> <span class="cn">TRUE</span>, <span class="co">## inclusion ou non de la tendance</span></span>
<span>  refit <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span>, <span class="co">## si l'on refit le modèle après chaque alarme</span></span>
<span>  <span class="co">## cARL = seuil pour la statistique GLR (arbitraire)</span></span>
<span>     <span class="co">## 3 ~ seuil intermédiaire pour minimiser les faux positifs</span></span>
<span>     <span class="co">## 1 s'ajuste aux 99%PI de glm.nb - avec des changements après les pics (seuil abaissé pour l'alerte)</span></span>
<span>   c.ARL <span class="op">=</span> <span class="fl">2</span>,</span>
<span>   <span class="co"># thêta = log(1.5), ## équivaut à une augmentation de 50% des cas dans une épidémie</span></span>
<span>   ret <span class="op">=</span> <span class="st">"cases"</span> <span class="co">## retourne la limite supérieure du seuil sous forme de nombre de cas</span></span>
<span>  <span class="op">)</span></span>
<span></span>
<span><span class="co">## appliquer la méthode glrnb</span></span>
<span><span class="va">glrnbmethod</span> <span class="op">&lt;-</span> <span class="fu">glrnb</span><span class="op">(</span><span class="va">counts_sts</span>, control <span class="op">=</span> <span class="va">ctrl</span>, verbose <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## créer une nouvelle variable dans l'ensemble de données original appelée threshold</span></span>
<span><span class="co">## contenant la limite supérieure de glrnb. </span></span>
<span><span class="co">## nb. ceci est seulement pour les semaines de 2011 (donc besoin de sous-ensembler les lignes)</span></span>
<span><span class="va">counts</span><span class="op">[</span><span class="fu"><a href="https://rdrr.io/r/base/which.html">which</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">epiweek</span> <span class="op">&gt;=</span> <span class="va">cut_off</span> <span class="op">&amp;</span> </span>
<span>               <span class="op">!</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span><span class="op">(</span><span class="va">counts</span><span class="op">$</span><span class="va">case_int</span><span class="op">)</span><span class="op">)</span>,</span>
<span>              <span class="st">"threshold_glrnb"</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="va">glrnbmethod</span><span class="op">@</span><span class="va">upperbound</span></span></code></pre></div>
<p>Visualisez les sorties comme précédemment.</p>
<div class="sourceCode" id="cb1156"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">counts</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajouter le nombre de cas observés sous forme de ligne</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span>, colour <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajout de la limite supérieure de l'algorithme d'aberration</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">threshold_glrnb</span>, color <span class="op">=</span> <span class="st">"Alert threshold"</span><span class="op">)</span>, </span>
<span>            linetype <span class="op">=</span> <span class="st">"dashed"</span>, </span>
<span>            size <span class="op">=</span> <span class="fl">1.5</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="co">## définir les couleurs</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                                 <span class="st">"Alert threshold"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## faire un graphique traditionnel (avec des axes noirs et un fond blanc)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## supprimer le titre de la légende </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/theme.html">theme</a></span><span class="op">(</span>legend.title <span class="op">=</span> <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/element.html">element_blank</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/plot_glrnb-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
</div>
</div>
<div id="série-chronologique-interrompue" class="section level2" number="23.8">
<h2>
<span class="header-section-number">23.8</span> Série chronologique interrompue<a class="anchor" aria-label="anchor" href="#s%C3%A9rie-chronologique-interrompue"><i class="fas fa-link"></i></a>
</h2>
<p>Les séries chronologiques interrompues (également appelées régression segmentée ou analyse d’intervention), est souvent utilisée pour évaluer l’impact des vaccins sur l’incidence des maladies. Mais elle peut être utilisée pour évaluer l’impact d’un large éventail d’interventions ou d’introductions. Par exemple, des changements dans les procédures hospitalières ou l’introduction d’une nouvelle souche de maladie dans une population. Dans cet exemple, nous supposerons qu’une nouvelle souche de Campylobacter a été introduite en Allemagne fin 2008, et nous verrons si cela affecte le nombre de cas. Nous utiliserons à nouveau la régression binomiale négative. Cette fois-ci, la régression sera divisée en deux parties, l’une avant l’intervention (ou l’introduction de la nouvelle souche ici) et une autre après (les périodes pré et post). Cela nous permet de calculer un ratio de taux d’incidence comparant les deux périodes. Une explication de l’équation pourrait rendre les choses plus claires (sinon, ignorez-la !).</p>
<p>La régression binomiale négative peut être définie comme suit :</p>
<p><span class="math display">\[\log(Y_t)= Î²_0 + Î²_1 \times t+ Î²_2 \times Î´(t-t_0) + Î²_3\times(t-t_0 )^+ + log(pop_t) + e_t\]</span></p>
<p>Où :
<span class="math inline">\(Y_t\)</span> est le nombre de cas observés au temps <span class="math inline">\(t\)</span>.<br><span class="math inline">\(pop_t\)</span> est la taille de la population en 100 000 au moment <span class="math inline">\(t\)</span> (non utilisé ici)<br><span class="math inline">\(t_0\)</span> est la dernière année de la pré-période (y compris la période de transition, le cas échéant).<br><span class="math inline">\(Î'(x\)</span> est la fonction indicatrice (elle vaut 0 si xâ¤0 et 1 si x&gt;0)<br><span class="math inline">\((x)^+\)</span> est l’opérateur de coupure (il vaut x si x&gt;0 et 0 sinon)<br><span class="math inline">\(e_t\)</span> désigne le résidu
Des termes supplémentaires, tendance et saison, peuvent être ajoutés si nécessaire.</p>
<p><span class="math inline">\(Î²_2 \times Î'(t-t_0) + Î²_3\times(t-t_0 )^+\)</span> est la partie linéaire généralisée de la post-période et est nulle dans la pré-période. Cela signifie que les estimations de <span class="math inline">\(Î²_2\)</span> et <span class="math inline">\(Î²_3\)</span> sont les effets de l’intervention.</p>
<p>Nous devons recalculer les termes de fourier sans faire de prévision ici, car nous utiliserons toutes les données dont nous disposons (c’est-à-dire rétrospectivement). De plus, nous devons calculerles termes supplémentaires nécessaires à la régression.</p>
<div class="sourceCode" id="cb1157"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## ajouter les termes de fourier en utilisant les variabless epiweek et case_int</span></span>
<span><span class="va">counts</span><span class="op">$</span><span class="va">fourier</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span><span class="va">counts</span>, <span class="va">epiweek</span>, <span class="va">case_int</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">as_tsibble</span><span class="op">(</span>index <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu">fourier</span><span class="op">(</span>K <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## définir la semaine d'intervention </span></span>
<span><span class="va">intervention_week</span> <span class="op">&lt;-</span> <span class="fu">yearweek</span><span class="op">(</span><span class="st">"2008-12-31"</span><span class="op">)</span></span>
<span></span>
<span><span class="co">## définir les variables pour la régression </span></span>
<span><span class="va">counts</span> <span class="op">&lt;-</span> <span class="va">counts</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## correspond à t dans la formule</span></span>
<span>      <span class="co">## nombre de semaines (on pourrait probablement aussi utiliser la variable epiweeks)</span></span>
<span>    <span class="co"># linear = row_number(epiweek), </span></span>
<span>    <span class="co">## correspond au delta(t-t0) dans la formule</span></span>
<span>      <span class="co">## période de pré ou post intervention</span></span>
<span>    intervention <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html">as.numeric</a></span><span class="op">(</span><span class="va">epiweek</span> <span class="op">&gt;=</span> <span class="va">intervention_week</span><span class="op">)</span>, </span>
<span>    <span class="co">## correspond à (t-t0)^+ dans la formule</span></span>
<span>      <span class="co">## nombre de semaines après l'intervention</span></span>
<span>      <span class="co">## (choisir le plus grand nombre entre 0 et ce qui ressort du calcul)</span></span>
<span>    time_post <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">pmax</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">epiweek</span> <span class="op">-</span> <span class="va">intervention_week</span> <span class="op">+</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span></span></code></pre></div>
<p>Nous utilisons ensuite ces termes pour ajuster une régression binomiale négative, et produisons un tableau avec le pourcentage de changement. Cet exemple montre qu’il n’y a pas eu de changement significatif.</p>
<p><span style="color : orange ;"><strong><em>ATTENTION:</em></strong> Notez l’utilisation de <code>simulate_pi = FALSE</code> dans l’argument <code><a href="https://rdrr.io/r/stats/predict.html">predict()</a></code>. Ceci est dû au fait que le comportement par défaut de <strong>trending</strong> est d’utiliser le paquet <strong>ciTools</strong> pour estimer un intervalle de prédiction. Cela ne fonctionne pas s’il y a des comptes <code>NA</code>, et produit également des intervalles plus granulaires. Voir <code>?trending::predict.trending_model_fit</code> pour plus de détails. </span></p>
<div class="sourceCode" id="cb1158"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## définissez le modèle que vous voulez ajuster (binomial négatif). </span></span>
<span><span class="va">model</span> <span class="op">&lt;-</span> <span class="fu">glm_nb_model</span><span class="op">(</span></span>
<span>  <span class="co">## définir le nombre de cas comme résultat d'intérêt</span></span>
<span>  <span class="va">case_int</span> <span class="op">~</span></span>
<span>    <span class="co">## utiliser epiweek pour tenir compte de la tendance</span></span>
<span>    <span class="va">epiweek</span> <span class="op">+</span></span>
<span>    <span class="co">## utiliser les termes fourier pour tenir compte de la saisonnalité</span></span>
<span>    <span class="va">fourier</span> <span class="op">+</span> </span>
<span>    <span class="co">## ajouter si dans la pré ou post-période </span></span>
<span>    <span class="va">intervention</span> <span class="op">+</span> </span>
<span>    <span class="co">## ajouter le temps après l'intervention </span></span>
<span>    <span class="va">time_post</span></span>
<span>    <span class="op">)</span></span>
<span></span>
<span><span class="co">## ajustez votre modèle en utilisant l'ensemble de données de comptage</span></span>
<span><span class="va">fitted_model</span> <span class="op">&lt;-</span> <span class="fu">trending</span><span class="fu">::</span><span class="fu"><a href="https://rdrr.io/pkg/trending/man/fit.html">fit</a></span><span class="op">(</span><span class="va">model</span>, <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">counts</span><span class="op">)</span><span class="op">)</span></span>
<span></span>
<span><span class="co">### calculer les intervalles de confiance et les intervalles de prédiction </span></span>
<span><span class="va">observed</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/predict.html">predict</a></span><span class="op">(</span><span class="va">fitted_model</span>, simulate_pi <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span></span></code></pre></div>
<div class="sourceCode" id="cb1159"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co">## Afficher les estimations et le pourcentage de changement dans un tableau</span></span>
<span><span class="va">fitted_model</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## extraire la régression binomiale négative originale</span></span>
<span>  <span class="fu">get_fitted_model</span><span class="op">(</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## obtenir un cadre de données ordonné des résultats</span></span>
<span>  <span class="fu">tidy</span><span class="op">(</span>exponentiate <span class="op">=</span> <span class="cn">TRUE</span>, </span>
<span>       conf.int <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> <span class="co">### ne conserve que les valeurs d'intervention </span></span>
<span>  <span class="co">### ne conserve que la valeur d'intervention </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span><span class="op">(</span><span class="va">term</span> <span class="op">==</span> <span class="st">"intervention"</span><span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## changer le IRR en pourcentage de changement pour l'estimation et les ICs </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span><span class="op">(</span></span>
<span>    <span class="co">## pour chacune des colonnes d'intérêt - créer une nouvelle colonne</span></span>
<span>    <span class="fu"><a href="https://dplyr.tidyverse.org/reference/across.html">across</a></span><span class="op">(</span></span>
<span>      <span class="fu"><a href="https://tidyselect.r-lib.org/reference/all_of.html">all_of</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"estimate"</span>, <span class="st">"conf.low"</span>, <span class="st">"conf.high"</span><span class="op">)</span><span class="op">)</span>, </span>
<span>      <span class="co">## appliquer la formule pour calculer le pourcentage de changement</span></span>
<span>            .f <span class="op">=</span> <span class="kw">function</span><span class="op">(</span><span class="va">i</span><span class="op">)</span> <span class="fl">100</span> <span class="op">*</span> <span class="op">(</span><span class="va">i</span> <span class="op">-</span> <span class="fl">1</span><span class="op">)</span>, </span>
<span>      <span class="co">## ajouter un suffixe aux nouveaux noms de colonnes avec "_perc".</span></span>
<span>      .names <span class="op">=</span> <span class="st">"{.col}_perc"</span><span class="op">)</span></span>
<span>    <span class="op">)</span> <span class="op"><a href="https://magrittr.tidyverse.org/reference/pipe.html">%&gt;%</a></span> </span>
<span>  <span class="co">## ne garder (et renommer) que certaines colonnes </span></span>
<span>  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span><span class="op">(</span> <span class="st">"IRR"</span> <span class="op">=</span> <span class="va">estimate</span>, </span>
<span>         <span class="st">"95%CI low"</span> <span class="op">=</span> <span class="va">conf.low</span>, </span>
<span>         <span class="st">"95%CI high"</span> <span class="op">=</span> <span class="va">conf.high</span>,</span>
<span>         <span class="st">"Variation in percentag"</span> <span class="op">=</span> <span class="va">estimate_perc</span>, </span>
<span>         <span class="st">"95%CI low (perc)"</span> <span class="op">=</span> <span class="va">conf.low_perc</span>, </span>
<span>         <span class="st">"95%CI high (perc)"</span> <span class="op">=</span> <span class="va">conf.high_perc</span>,</span>
<span>         <span class="st">"p-value"</span> <span class="op">=</span> <span class="va">p.value</span><span class="op">)</span></span></code></pre></div>
<p>Comme précédemment, nous pouvons visualiser les résultats de la régression.</p>
<div class="sourceCode" id="cb1160"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">estimate_res</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html">data.frame</a></span><span class="op">(</span><span class="va">observed</span><span class="op">$</span><span class="va">result</span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span><span class="op">(</span><span class="va">estimate_res</span>, <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>x <span class="op">=</span> <span class="va">epiweek</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajouter le nombre de cas observés sous forme de ligne</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">case_int</span>, colour <span class="op">=</span> <span class="st">"Observed"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajout d'une ligne pour l'estimation du modèle</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_path.html">geom_line</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">estimate</span>, col <span class="op">=</span> <span class="st">"Estimate"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajouter une bande pour les intervalles de prédiction </span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_ribbon.html">geom_ribbon</a></span><span class="op">(</span><span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span><span class="op">(</span>ymin <span class="op">=</span> <span class="va">lower_pi</span>, </span>
<span>                  ymax <span class="op">=</span> <span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>              alpha <span class="op">=</span> <span class="fl">0.25</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## ajouter une ligne verticale et une étiquette pour montrer où la prévision a commencé</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/geom_abline.html">geom_vline</a></span><span class="op">(</span></span>
<span>           xintercept <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/as.Date.html">as.Date</a></span><span class="op">(</span><span class="va">intervention_week</span><span class="op">)</span>, </span>
<span>           linetype <span class="op">=</span> <span class="st">"dashed"</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/annotate.html">annotate</a></span><span class="op">(</span>geom <span class="op">=</span> <span class="st">"text"</span>, </span>
<span>           label <span class="op">=</span> <span class="st">"Intervention"</span>, </span>
<span>           x <span class="op">=</span> <span class="va">intervention_week</span>, </span>
<span>           y <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span><span class="op">(</span><span class="va">estimate_res</span><span class="op">$</span><span class="va">upper_pi</span><span class="op">)</span>, </span>
<span>           angle <span class="op">=</span> <span class="fl">90</span>, </span>
<span>           vjust <span class="op">=</span> <span class="fl">1</span></span>
<span>           <span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## définir les couleurs</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_manual.html">scale_colour_manual</a></span><span class="op">(</span>values <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span><span class="op">(</span><span class="st">"Observed"</span> <span class="op">=</span> <span class="st">"black"</span>, </span>
<span>                                 <span class="st">"Estimate"</span> <span class="op">=</span> <span class="st">"red"</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span> </span>
<span>  <span class="co">## faire un graphique traditionnel (avec des axes noirs et un fond blanc)</span></span>
<span>  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggtheme.html">theme_classic</a></span><span class="op">(</span><span class="op">)</span></span></code></pre></div>
<div class="inline-figure"><img src="_main_files/figure-html/plot_interrupted-1.png" width="672"></div>
<!-- ======================================================= -->
</div>
<div id="ressources-10" class="section level2" number="23.9">
<h2>
<span class="header-section-number">23.9</span> Ressources<a class="anchor" aria-label="anchor" href="#ressources-10"><i class="fas fa-link"></i></a>
</h2>
<p><a href="https://otexts.com/fpp3/">Prévision : principes et pratique - manuel</a><br><a href="https://github.com/EPIET/TimeSeriesAnalysis">Études de cas d’analyse de séries temporelles EPIET</a><br><a href="https://online.stat.psu.edu/stat510/lesson/1">Cours de Penn State</a>
<a href="https://www.jstatsoft.org/article/view/v070i10">Manuscrit du paquet de surveillance</a></p>

</div>
</div>
  <div class="chapter-nav">
<div class="prev"><a href="moving_average.html"><span class="header-section-number">22</span> Moyennes mobiles</a></div>
<div class="next"><a href="epidemic_models.html"><span class="header-section-number">24</span> Modélisation des épidémies</a></div>
</div></main><div class="col-md-3 col-lg-2 d-none d-md-block sidebar sidebar-chapter">
    <nav id="toc" data-toggle="toc" aria-label="On this page"><h2>On this page</h2>
      <ul class="nav navbar-nav">
<li><a class="nav-link" href="#time_series"><span class="header-section-number">23</span> Série temporelle et détection des épidémies</a></li>
<li><a class="nav-link" href="#aper%C3%A7u-1"><span class="header-section-number">23.1</span> Aperçu</a></li>
<li>
<a class="nav-link" href="#pr%C3%A9paration-6"><span class="header-section-number">23.2</span> Préparation</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#paquets">Paquets</a></li>
<li><a class="nav-link" href="#chargement-des-donn%C3%A9es">Chargement des données</a></li>
<li><a class="nav-link" href="#nettoyer-les-donn%C3%A9es-1">Nettoyer les données</a></li>
<li><a class="nav-link" href="#t%C3%A9l%C3%A9charger-les-donn%C3%A9es-climatiques">Télécharger les données climatiques</a></li>
<li><a class="nav-link" href="#charger-les-donn%C3%A9es-climatiques">Charger les données climatiques</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#donn%C3%A9es-de-s%C3%A9ries-temporelles"><span class="header-section-number">23.3</span> Données de séries temporelles</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#duplicates">Duplicates</a></li>
<li><a class="nav-link" href="#manques">Manques</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#analyse-descriptive"><span class="header-section-number">23.4</span> Analyse descriptive</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#timeseries_moving">Moyennes mobiles</a></li>
<li><a class="nav-link" href="#p%C3%A9riodicit%C3%A9">Périodicité</a></li>
<li><a class="nav-link" href="#d%C3%A9composition">Décomposition</a></li>
<li><a class="nav-link" href="#autocorr%C3%A9lation">Autocorrélation</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#ajustement-des-r%C3%A9gressions"><span class="header-section-number">23.5</span> Ajustement des régressions</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#termes-de-fourier">Termes de Fourier</a></li>
<li><a class="nav-link" href="#binomiale-n%C3%A9gative">Binomiale négative</a></li>
<li><a class="nav-link" href="#r%C3%A9sidus">Résidus</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#relation-entre-deux-s%C3%A9ries-temporelles"><span class="header-section-number">23.6</span> Relation entre deux séries temporelles</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#fusionner-des-ensembles-de-donn%C3%A9es">Fusionner des ensembles de données</a></li>
<li><a class="nav-link" href="#lags-et-corr%C3%A9lation-crois%C3%A9e">Lags et corrélation croisée</a></li>
<li><a class="nav-link" href="#binomiale-n%C3%A9gative-avec-deux-variables">Binomiale négative avec deux variables</a></li>
</ul>
</li>
<li>
<a class="nav-link" href="#d%C3%A9tection-des-%C3%A9pid%C3%A9mies"><span class="header-section-number">23.7</span> Détection des épidémies</a><ul class="nav navbar-nav">
<li><a class="nav-link" href="#tendance-paquet">tendance paquet</a></li>
<li><a class="nav-link" href="#surveillance-paquet">surveillance paquet</a></li>
</ul>
</li>
<li><a class="nav-link" href="#s%C3%A9rie-chronologique-interrompue"><span class="header-section-number">23.8</span> Série chronologique interrompue</a></li>
<li><a class="nav-link" href="#ressources-10"><span class="header-section-number">23.9</span> Ressources</a></li>
</ul>

      <div class="book-extra">
        <ul class="list-unstyled">
          
        </ul>
</div>
    </nav>
</div>

</div>
</div> <!-- .container -->

<footer class="bg-primary text-light mt-5"><div class="container"><div class="row">

  <div class="col-12 col-md-6 mt-3">
    <p>"<strong>Le Epi R Handbook</strong>" was written by the handbook team. It was last built on 2023-05-21.</p>
  </div>

  <div class="col-12 col-md-6 mt-3">
    <p>This book was built by the <a class="text-light" href="https://bookdown.org">bookdown</a> R package.</p>
  </div>

</div></div>
</footer><!-- dynamically load mathjax for compatibility with self-contained --><script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.9/latest.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script><script type="text/x-mathjax-config">const popovers = document.querySelectorAll('a.footnote-ref[data-toggle="popover"]');
for (let popover of popovers) {
  const div = document.createElement('div');
  div.setAttribute('style', 'position: absolute; top: 0, left:0; width:0, height:0, overflow: hidden; visibility: hidden;');
  div.innerHTML = popover.getAttribute('data-content');

  var has_math = div.querySelector("span.math");
  if (has_math) {
    document.body.appendChild(div);
    MathJax.Hub.Queue(["Typeset", MathJax.Hub, div]);
    MathJax.Hub.Queue(function() {
      popover.setAttribute('data-content', div.innerHTML);
      document.body.removeChild(div);
    })
  }
}
</script>
</body>
</html>
